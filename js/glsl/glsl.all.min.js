var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.source={},ns=ctx.glsl.source}else{var glsl={tokenizer:require("./tokenizer")};ns=exports}!function(exports){"use strict";function Location(line,column){this.line=line,this.column=column}function BuiltinLocation(){Location.call(this,0,0)}function Range(start,end){this.start=start.copy(),this.end=end.copy()}function BuiltinRange(){Range.call(this,new BuiltinLocation,new BuiltinLocation)}function SourceError(loc,message){this.location=loc.copy(),this.message=message,this._stack=(new Error).stack}function Source(s,type){this._source=s,this._remainder=this._source,this._location=new Location(1,1),this._type=type}Location.prototype.copy=function(){return new Location(this.line,this.column)},Location.prototype.to_range=function(){var rng=new Range(this,this);return rng.end.column++,rng},Location.prototype.inspect=function(){return this.line+"."+this.column},Location.prototype.marshal=function(){return this.line+"."+this.column},Location.prototype.compare=function(loc){return this.line!=loc.line?this.line<loc.line?-1:1:this.column!=loc.column?this.column<loc.column?-1:1:0},Location.prototype.advance_chars=function(n){var ret=this.copy();return ret.column+=n,ret},Location.prototype.advance=function(s){for(var li=-1,ret=this.copy(),i=0;i<s.length;i++)"\n"==s[i]&&(li=i,ret.line++);return-1!=li?ret.column=s.length-li:ret.column+=s.length,ret},BuiltinLocation.prototype=Object.create(Location.prototype),BuiltinLocation.prototype.constructor=BuiltinLocation,exports.BuiltinLocation=BuiltinLocation,BuiltinLocation.prototype.inspect=function(){return"(builtin)"},BuiltinLocation.prototype.marshal=function(){return"(builtin)"},BuiltinLocation.prototype.copy=function(){return new BuiltinLocation},Range.prototype.copy=function(){return new Range(this.start,this.end)},Range.prototype.inspect=function(depth){return"("+this.start.inspect(depth+1)+"-"+this.end.inspect(depth+1)+")"},Range.prototype.marshal=function(){return"("+this.start.marshal()+"-"+this.end.marshal()+")"},Range.prototype.extend=function(loc){var ret=this.copy();return Location.prototype.isPrototypeOf(loc)&&(loc=loc.to_range()),loc.start.compare(ret.start)<0&&(ret.start=loc.start.copy()),loc.end.compare(ret.end)>0&&(ret.end=loc.end.copy()),ret},Range.spans=function(){for(var locs=[],args=Array.prototype.slice.call(arguments);args.length>0;){var arg=args.pop();null!==arg&&(Range.prototype.isPrototypeOf(arg)?locs.push(arg):Location.prototype.isPrototypeOf(arg)?locs.push(arg.to_range()):Array.prototype.isPrototypeOf(arg)?args.concat(arg):"function"==typeof arg.location?args.push(arg.location()):"undefined"!=typeof arg.location&&args.push(arg.location))}if(0===locs.length)return new Range(new Location(0,0),new Location(0,0));for(var ret=locs[0].copy(),i=1;i<locs.length;i++){var loc=locs[i];loc.start.compare(ret.start)<0&&(ret.start=loc.start.copy()),loc.end.compare(ret.end)>0&&(ret.end=loc.end.copy())}return ret},BuiltinRange.prototype=Object.create(Range.prototype),BuiltinRange.prototype.constructor=BuiltinRange,BuiltinRange.prototype.inspect=function(){return"(builtin)"},BuiltinRange.prototype.marshal=function(){return"(builtin)"},BuiltinRange.prototype.copy=function(){return new BuiltinRange},exports.BuiltinRange=BuiltinRange,SourceError.prototype.formatted_message=function(){var l=this.location.start.line,c=this.location.start.column;return l+"."+c+": "+this.message},Source.prototype.location=function(){return this._location},Source.prototype.offset=function(loc){this._location=loc.copy()},Source.prototype.eof=function(){return 0===this._remainder.length},Source.prototype._source_map=function(loc){return loc},Source.prototype.skip=function(r){this._next(r,!1)},Source.prototype.source=function(){return this._source},Source.prototype.next=function(r){return this._next(r,!0)},Source.prototype.type=function(){return this._type},Source.prototype._next=function(r,tokenize){var m=this._remainder.match(r);if(m&&0===m.index){var l=m[0].length,start=this._location.copy();if(this._remainder=this._remainder.slice(l),this._location=this._location.advance(m[0]),tokenize){var rng=this._source_map(new Range(start,this._location));return new glsl.tokenizer.Token(0,m[0],rng)}}return null},exports.Error=SourceError,exports.Location=Location,exports.Range=Range,exports.Source=Source,exports.VERTEX=0,exports.FRAGMENT=1}(ns);var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.tokenizer={},ns=ctx.glsl.tokenizer}else{var glsl={};ns=exports}!function(exports){"use strict";function Token(id,text,loc,comments){this.id=id,this.text=text,this.location=loc,this._tokenizer=null,this.comments="undefined"==typeof comments?[]:comments}function BaseTokenizer(b,options){this._options=this._merge_options({floats:!1,ints:!1,bools:!1,comments:!1,skip_comments:!0,whitespace_class:/^[ \t\n]+/,identifier_class:/^[A-Za-z_][A-Za-z0-9_]*/,float_class:/((\d+\.\d*|\.\d+)([eE][+-]?\d+)?|\d+[eE][+-]?\d+)/,line_comment_class:/^\/\/.*/,multiline_comment_class:/^\/\*(.|\n)*?\*\//,bool_class:/^(true|false)\b/,hexadecimal_class:/^0[xX][0-9a-fA-F]+/,octal_class:/^0[0-7]*/,decimal_class:/^[1-9][0-9]*/},options),this._keywords="undefined"!=typeof b.keywords?b.keywords:{},this._operators="undefined"!=typeof b.operators?b.operators:{},this._token_id_map={},this._token_name_map={},this._last_token_id=0,this._define_token(b,"identifier","IDENTIFIER"),this._define_token(b,"unsupported","UNSUPPORTED"),this._define_token(b,"eof","EOF"),this._define_tokens(b,this._keywords),this._define_tokens(b,this._operators),this._options.floats&&this._define_token(b,"floating point number","FLOATCONSTANT"),this._options.ints&&this._define_token(b,"integer number","INTCONSTANT"),this._options.bools&&this._define_token(b,"boolean value","BOOLCONSTANT"),this._options.comments&&this._define_token(b,"comment","COMMENT"),this._extract_operators(),b.token_name=this.token_name.bind(this),b.token_id_name=this.token_id_name.bind(this)}function regex_escape(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function regex_choices(l){l=l.slice(0),l.sort(function(a,b){return a.length>b.length?-1:b.length>a.length?1:0});for(var i=0;i<l.length;i++)l[i]=regex_escape(l[i]);return"("+l.join("|")+")"}function Tokenizer(source){BaseTokenizer.prototype.init.call(this,source)}Token.prototype.marshal=function(){var ret=this._tokenizer.token_id_name(this.id)+":"+this.text+"@"+this.location.marshal();if(this.comments.length>0){for(var c=[ret],i=0;i<this.comments.length;i++)c.push(this.comments[i].marshal());return c}return ret},Token.prototype.for_assert=function(){var ret=new Token(this.id,this.text,this.location);ret._tokenizer=this._tokenizer;for(var k in this){var val=this[k];this.hasOwnProperty(k)&&!ret.hasOwnProperty(k)&&"function"!=typeof val&&(ret[k]=val)}return ret},exports.Token=Token,BaseTokenizer.prototype._merge_options=function(defs,options){if("undefined"==typeof options)return defs;for(var k in options)defs[k]=options[k];return defs},BaseTokenizer.prototype.init=function(source){this._source=source,this._cached=[],this._matchers=[],this._options.comments&&(this._matchers.push({regex:this._options.line_comment_class,finish_token:function(tok){tok.id=this._token("COMMENT"),tok.multi=!1,tok.value=tok.text.slice(2),tok.marshal=function(){return Token.prototype.marshal.call(this)+", multi:"+this.multi+" = "+this.value}}.bind(this)}),this._matchers.push({regex:this._options.multiline_comment_class,finish_token:function(tok){tok.id=this._token("COMMENT"),tok.multi=!0,tok.value=tok.text.slice(2,tok.text.length-2),tok.marshal=function(){return Token.prototype.marshal.call(this)+", multi:"+this.multi+" = "+this.value}}.bind(this)})),this._matchers.push({regex:this._roperators,finish_token:function(tok){tok.id=this._token(this._operators[tok.text])}.bind(this)}),this._options.bools&&this._matchers.push({regex:this._options.bool_class,finish_token:function(tok){tok.id=this._token("BOOLCONSTANT"),tok.value="true"==tok.text,tok.marshal=function(){return Token.prototype.marshal.call(this)+" = "+this.value}}.bind(this)}),this._matchers.push({regex:this._options.identifier_class,finish_token:function(tok){tok.id=tok.text in this._keywords?this._token(this._keywords[tok.text]):this.T_IDENTIFIER}.bind(this)}),this._options.floats&&this._matchers.push({regex:this._options.float_class,finish_token:function(tok){tok.id=this._token("FLOATCONSTANT"),tok.value=parseFloat(tok.text),tok.marshal=function(){return Token.prototype.marshal.call(this)+" = "+this.value}}.bind(this)}),this._options.ints&&(this._matchers.push({regex:this._options.hexadecimal_class,finish_token:function(tok){tok.id=this._token("INTCONSTANT"),tok.value=parseInt(tok.text.slice(2),16),tok.marshal=function(){return Token.prototype.marshal.call(this)+" = "+this.value}}.bind(this)}),this._matchers.push({regex:this._options.decimal_class,finish_token:function(tok){tok.id=this._token("INTCONSTANT"),tok.value=parseInt(tok.text,10),tok.marshal=function(){return Token.prototype.marshal.call(this)+" = "+this.value}}.bind(this)}),this._matchers.push({regex:this._options.octal_class,finish_token:function(tok){tok.id=this._token("INTCONSTANT"),tok.value=parseInt(tok.text,8),tok.marshal=function(){return Token.prototype.marshal.call(this)+" = "+this.value}}.bind(this)}))},BaseTokenizer.prototype.create_token=function(id,text,location){var tok=new Token(id,text,location);return tok._tokenizer=this,tok},BaseTokenizer.prototype._extract_operators=function(){var ops=[];for(var op in this._operators)ops.push(op);this._roperators=0!==ops.length?new RegExp("^"+regex_choices(ops)):null},BaseTokenizer.prototype._define_token=function(b,name,t){var id=++this._last_token_id;this["T_"+t]=id,b["T_"+t]=id,this._token_id_map[id]=t,this._token_name_map[id]=name},BaseTokenizer.prototype.token_name=function(id){return this._token_name_map[id]},BaseTokenizer.prototype.token_id_name=function(id){return this._token_id_map[id]},BaseTokenizer.prototype._define_tokens=function(b,tmap){var ids=[];for(var k in tmap)ids.push(k);ids.sort();for(var i=0;i<ids.length;i++)this._define_token(b,ids[i],tmap[ids[i]])},BaseTokenizer.prototype._skip_ws=function(){this._source.skip(this._options.whitespace_class)},BaseTokenizer.prototype.peek=function(){return this.unconsume(this.next())},BaseTokenizer.prototype.unconsume=function(tok){return this._cached.unshift(tok),tok},BaseTokenizer.prototype._post_comments=function(tok){for(this._options.skip_comments=!1;;){var ntok=this.peek();if(ntok.id!=this.T_COMMENT)break;if(ntok.location.start.line!=tok.location.start.line)break;tok.comments.push(ntok),this.next()}return this._options.skip_comments=!0,tok},BaseTokenizer.prototype.next=function(){var comments=[];if(this._options.comments&&this._options.skip_comments)for(;this._cached.length>0&&this._cached[0].id==this.T_COMMENT;)comments.push(this._cached.shift());if(0!==this._cached.length){var ret=this._cached.shift();return ret.comments=ret.comments.concat(comments),ret}for(var processing_comments=!0;processing_comments;){if(processing_comments=!1,this._skip_ws(),this._source.eof()){var tok=new Token(this.T_EOF,"",this.location().to_range(),comments);return tok._tokenizer=this,tok}for(var i=0;i<this._matchers.length;i++){var m=this._matchers[i];if(null!==m.regex){var tok=this._source.next(m.regex);if(null!==tok){if(tok._tokenizer=this,m.finish_token(tok),tok.id!=this.T_COMMENT)return tok.comments=comments,this._options.comments&&this._options.skip_comments?this._post_comments(tok):tok;if(!this._options.comments||!this._options.skip_comments)return tok;comments.push(tok),processing_comments=!0;break}}}}var tok=this._source.next(/./);return tok.id=this.T_UNSUPPORTED,tok},BaseTokenizer.prototype.remainder=function(){return this._skip_ws(),this._source.next(/.*/)},BaseTokenizer.prototype.eof=function(){return this._source.eof()},BaseTokenizer.prototype.location=function(){return this._source.location()},BaseTokenizer.prototype._token=function(n){return this["T_"+n]},Tokenizer.keywords={attribute:"ATTRIBUTE","const":"CONST",bool:"BOOL","float":"FLOAT","int":"INT","break":"BREAK","continue":"CONTINUE","do":"DO","else":"ELSE","for":"FOR","if":"IF",discard:"DISCARD","return":"RETURN",bvec2:"BVEC2",bvec3:"BVEC3",bvec4:"BVEC4",ivec2:"IVEC2",ivec3:"IVEC3",ivec4:"IVEC4",vec2:"VEC2",vec3:"VEC3",vec4:"VEC4",mat2:"MAT2",mat3:"MAT3",mat4:"MAT4","in":"IN",out:"OUT",inout:"INOUT",uniform:"UNIFORM",varying:"VARYING",sampler2D:"SAMPLER2D",samplerCube:"SAMPLERCUBE",struct:"STRUCT","void":"VOID","while":"WHILE",invariant:"INVARIANT",highp:"HIGH_PRECISION",mediump:"MEDIUM_PRECISION",lowp:"LOW_PRECISION",precision:"PRECISION"},Tokenizer.operators={"<<":"LEFT_OP",">>":"RIGHT_OP","++":"INC_OP","--":"DEC_OP","<=":"LE_OP",">=":"GE_OP","==":"EQ_OP","!=":"NE_OP","&&":"AND_OP","||":"OR_OP","^^":"XOR_OP","*=":"MUL_ASSIGN","/=":"DIV_ASSIGN","+=":"ADD_ASSIGN","%=":"MOD_ASSIGN","<<=":"LEFT_ASSIGN",">>=":"RIGHT_ASSIGN","&=":"AND_ASSIGN","^=":"XOR_ASSIGN","|=":"OR_ASSIGN","-=":"SUB_ASSIGN","(":"LEFT_PAREN",")":"RIGHT_PAREN","[":"LEFT_BRACKET","]":"RIGHT_BRACKET","{":"LEFT_BRACE","}":"RIGHT_BRACE",".":"DOT",",":"COMMA",":":"COLON","=":"EQUAL",";":"SEMICOLON","!":"BANG","-":"DASH","~":"TILDE","+":"PLUS","*":"STAR","/":"SLASH","%":"PERCENT","<":"LEFT_ANGLE",">":"RIGHT_ANGLE","|":"VERTICAL_BAR","^":"CARET","&":"AMPERSAND","?":"QUESTION"},Tokenizer.prototype=new BaseTokenizer(Tokenizer,{floats:!0,ints:!0,bools:!0,comments:!0}),exports.Base=BaseTokenizer,exports.Tokenizer=Tokenizer,exports.regex_choices=regex_choices,exports.regex_escape=regex_escape}(ns);var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.preprocessor={},ns=ctx.glsl.preprocessor}else{var glsl={tokenizer:require("./tokenizer"),source:require("./source")};ns=exports}!function(exports){"use strict";function ExpressionTokenizer(source){glsl.tokenizer.Base.prototype.init.call(this,source)}function Tokenizer(source){glsl.tokenizer.Base.prototype.init.call(this,source)}function Preprocessor(source,type,options){if(this._source="",this._type=type,this._defines={__VERSION__:"100",__LINE__:"0",__FILE__:"0",GL_ES:"1"},"undefined"==typeof options&&(options={}),"undefined"!=typeof options.defines)for(var k in options.defines)this._defines[k]=options.defines[k];this._source_mapping=[],this._source_location=new glsl.source.Location(1,1);var lines=source.split("\n");this._pstack=[{skip:!1}],this._errors=[],this._tokens=[];for(var incomment=!1,i=0;i<lines.length;i++){var line=lines[i],ptr=0;if(incomment){var opos=line.lastIndexOf("/*"),cpos=line.lastIndexOf("*/");-1!=cpos&&cpos>opos&&(incomment=!1),ptr=line.length}else for(;ptr<line.length&&(" "==line[ptr]||"	"==line[ptr]);)ptr++;var p=this._pstack[this._pstack.length-1];if(ptr<line.length&&"#"==line[ptr]){var lsource=new glsl.source.Source(line.slice(ptr+1));lsource.offset(new glsl.source.Location(i,ptr+1));var tokenizer=new Tokenizer(lsource),tok=tokenizer.next();switch(tok.id){case Tokenizer.T_ENDIF:this._endif(tok,tokenizer);break;case Tokenizer.T_ELSE:this._else(tok,tokenizer);break;case Tokenizer.T_ELIF:this._elif(tok,tokenizer)}if(tok.id==Tokenizer.T_ENDIF||tok.id==Tokenizer.T_ELSE||tok.id==Tokenizer.ELIF||p.skip)continue;switch(tok.id){case Tokenizer.T_DEFINE:this._define(tok,tokenizer);break;case Tokenizer.T_UNDEF:this._undef(tok,tokenizer);break;case Tokenizer.T_IF:this._if(tok,tokenizer);break;case Tokenizer.T_IFDEF:this._ifdef(tok,tokenizer,!1);break;case Tokenizer.T_IFNDEF:this._ifdef(tok,tokenizer,!0);break;case Tokenizer.T_ERROR:this._error(tok.location,tokenizer.remainder().text);break;case Tokenizer.T_PRAGMA:break;case Tokenizer.T_EXTENSION:break;case Tokenizer.T_VERSION:break;case Tokenizer.T_LINE:break;default:this._error(tok.location,"expected preprocessor directive, but got "+tokenizer.token_name(tok.id)+":"+tok.text)}}else p.skip||(i!=lines.length-1&&(line+="\n"),this._add_source(line,new glsl.source.Location(i+1,1)));var opos=line.lastIndexOf("/*"),cpos=line.lastIndexOf("*/");-1!=opos&&opos>cpos&&(incomment=!0)}this._source_reader=new glsl.source.Source(this._source,this._type),this._source_reader._source_map=this._source_map.bind(this)}ExpressionTokenizer.keywords={defined:"DEFINED"},ExpressionTokenizer.operators={"<<":"LEFT_OP",">>":"RIGHT_OP","<=":"LE_OP",">=":"GE_OP","==":"EQ_OP","!=":"NE_OP","&&":"AND_OP","||":"OR_OP","^^":"XOR_OP","(":"LEFT_PAREN",")":"RIGHT_PAREN",",":"COMMA","!":"BANG","-":"DASH","~":"TILDE","+":"PLUS","*":"STAR","/":"SLASH","%":"PERCENT","<":"LEFT_ANGLE",">":"RIGHT_ANGLE","|":"VERTICAL_BAR","^":"CARET","&":"AMPERSAND"},ExpressionTokenizer.prototype=new glsl.tokenizer.Base(ExpressionTokenizer,{ints:!0}),Tokenizer.keywords={define:"DEFINE",undef:"UNDEF","if":"IF",ifdef:"IFDEF",ifndef:"IFNDEF","else":"ELSE",elif:"ELIF",endif:"ENDIF",error:"ERROR",pragma:"PRAGMA",extension:"EXTENSION",version:"VERSION",line:"LINE"},Tokenizer.prototype=new glsl.tokenizer.Base(Tokenizer),Preprocessor.options_from_context=function(c){for(var exts=c.getSupportedExtensions(),defines={},i=0;i<exts.length;i++)defines[ext[i]]="1";return{defines:defines}},Preprocessor.prototype.type=function(){return this._source.type()},Preprocessor.prototype._source_map=function(range){return new glsl.source.Range(this._source_map_one(range.start,!1),this._source_map_one(range.end,!0))},Preprocessor.prototype._source_map_one=function(loc,isend){for(var i=0;i<this._source_mapping.length;i++){var m=this._source_mapping[i];if(m.current.start.compare(loc)>0)break;if(!(isend&&m.current.end.compare(loc)<0||!isend&&m.current.end.compare(loc)<=0)){if(m.macro)return isend?m.original.end.copy():m.original.start.copy();var mapped=m.original.start.copy();return mapped.line+=loc.line-m.current.start.line,loc.line==m.current.start.line&&(mapped.column+=loc.column-m.current.start.column),mapped}}return loc},Preprocessor.prototype.eof=function(){return this._source_reader.eof()},Preprocessor.prototype.skip=function(r){this._source_reader.skip(r)},Preprocessor.prototype.next=function(r){return this._source_reader.next(r)},Preprocessor.prototype.location=function(){return this._source_reader.location()},Preprocessor.prototype.errors=function(){return this._errors},Preprocessor.prototype._add_source=function(s,orig){var expanded=this._expand(s,orig,this._source_location);this._source+=expanded.text;for(var i=0;i<expanded.mapping.length;i++)this._source_mapping.push(expanded.mapping[i]),i==expanded.mapping.length-1&&(this._source_location=expanded.mapping[i].current.end.copy())},Preprocessor.prototype._expand=function(s,origloc,curloc){var defre=[],trackloc="undefined"!=typeof origloc;for(var d in this._defines)defre.push(d);defre=new RegExp("\\b"+glsl.tokenizer.regex_choices(defre)+"\\b","g");var smap=[],ploc=origloc,poff=0,pnewloc=curloc,ret=s.replace(defre,function(m,p1,offset){var d=this._defines[m];if(trackloc){var pt=s.slice(poff,offset),nloc=ploc.advance(pt),nnewloc=pnewloc.advance(pt);poff!=offset&&smap.push({current:new glsl.source.Range(pnewloc,nnewloc),original:new glsl.source.Range(ploc,nloc),macro:!1}),ploc=nloc.advance(m),pnewloc=nnewloc.advance(d),poff=offset+m.length,smap.push({current:new glsl.source.Range(nnewloc,pnewloc),original:new glsl.source.Range(nloc,ploc),macro:!0})}return d}.bind(this));if(trackloc){var pt=s.slice(poff);return smap.push({current:new glsl.source.Range(pnewloc,pnewloc.advance(pt)),original:new glsl.source.Range(ploc,ploc.advance(pt)),macro:!1}),{text:ret,mapping:smap}}return ret},Preprocessor.prototype._strip_comments=function(s){var cpos=s.indexOf("//");return-1!=cpos?s.slice(0,cpos):s},Preprocessor.prototype._define=function(tok,tokenizer){var def=tokenizer.next();if(def.id!=Tokenizer.T_IDENTIFIER)return void this._error(def.location,"expected identifier, but got "+tokenizer.token_name(def.id)+":"+def.text);if(0===def.text.indexOf("__"))return void this._error(def.location,"defines are not allowed to start with __");if(0===def.text.indexOf("GL_"))return void this._error(def.location,"defines are not allowed to start with GL_");var rest=tokenizer.remainder();this._defines[def.text]=this._expand(this._strip_comments(rest.text))},Preprocessor.prototype._undef=function(tok,tokenizer){var def=tokenizer.next();if(def.id!=Tokenizer.T_IDENTIFIER)return void this._error(def.location,"expected identifier, but got "+tokenizer.token_name(def.id)+":"+def.text);var next=tokenizer.next();next.id!=Tokenizer.T_EOF?this._error(next.location,"unexpected input after defined, got "+tokenizer.token_name(next.id)+":"+next.text):delete this._defines[def.text]},Preprocessor.prototype._if=function(tok,tokenizer){var rest=tokenizer.remainder(),exprtok=new ExpressionTokenizer(new glsl.source.Source(rest.text)),expr=this._parse_expression(exprtok,-1);null!==expr&&this._pstack.push({skip:!expr,condition:expr})},Preprocessor.prototype._ifdef=function(tok,tokenizer,negate){var def=tokenizer.next();if(def.id!=Tokenizer.T_IDENTIFIER)return void this._error(def.location,"expected identifier, but got "+tokenizer.token_name(def.id)+":"+def.text);var next=tokenizer.next();if(next.id!=Tokenizer.T_EOF)this._error(next.location,"unexpected input after defined, got "+tokenizer.token_name(next.id)+":"+next.text);else{var skip=!(def.text in this._defines);negate&&(skip=!skip),this._pstack.push({skip:skip,condition:!skip})}},Preprocessor.prototype._else=function(tok){if(1==this._pstack.length)return void this._error(tok.location,"unexpected #else without opening #if, #ifdef, or #ifndef");var p=this._pstack[this._pstack.length-1];p.condition?p.skip=!0:(p.skip=!1,p.condition=!0)},Preprocessor.prototype._elif=function(tok,tokenizer){if(1==this._pstack.length)return void this._error(tok.location,"unexpected #elif without opening #if, #ifdef, or #ifndef");var p=this._pstack[this._pstack.length-1];if(p.condition)return void(p.skip=!0);var rest=tokenizer.remainder(),s=this._expand(this._strip_comments(rest.text)),exprtok=new ExpressionTokenizer(new glsl.source.Source(s)),expr=this._parse_expression(exprtok,-1);return null===expr?void(p.skip=!0):(p.skip=!expr,void(p.condition=expr))},Preprocessor.prototype._endif=function(tok,tokenizer){return tokenizer.eof()?1==this._pstack.length?void this._error(tok.location,"unexpected #endif without opening #if, #ifdef, or #ifndef"):void this._pstack.pop():void this._error(tok.location,"unexpected input after #endif")},Preprocessor.prototype._parse_expression_primary=function(tokenizer){var tok=tokenizer.next();switch(tok.id){case ExpressionTokenizer.T_INTCONSTANT:return tok.value;case ExpressionTokenizer.T_IDENTIFIER:return tok.text in this._defines?this._defines[tok.text]:null;case ExpressionTokenizer.T_LEFT_PAREN:var ret=this._parse_expression(tokenizer);return null===ret?null:(tok=tokenizer.next(),tok.id!=ExpressionTokenizer.T_RIGHT_PAREN?null:ret);case ExpressionTokenizer.T_DEFINED:var id=tokenizer.next(),expect=null;if(id.id==ExpressionTokenizer.T_LEFT_PAREN&&(expect=ExpressionTokenizer.T_RIGHT_PAREN,id=tokenizer.next()),id.id!=ExpressionTokenizer.T_IDENTIFIER)return null;if(expect){var e=tokenizer.next();if(e.id!=expect)return null}return id.text in this._defines;case ExpressionTokenizer.T_PLUS:case ExpressionTokenizer.T_DASH:case ExpressionTokenizer.T_TILDE:case ExpressionTokenizer.T_BANG:var ret=this._parse_expression(tokenizer,2);if(null===ret)return null;switch(tok.id){case ExpressionTokenizer.T_PLUS:return ret;case ExpressionTokenizer.T_DASH:return-ret;case ExpressionTokenizer.T_TILDE:return~ret;case ExpressionTokenizer.T_BANG:return!ret}}return this._error(tok.location,"expected expression, but got "+ExpressionTokenizer.token_name(tok.id)+":"+tok.text),null},Preprocessor.prototype._parse_expression_binop=function(tokenizer,p,lhs){var tok=tokenizer.peek(),prec=0;switch(tok.id){case ExpressionTokenizer.T_STAR:case ExpressionTokenizer.T_SLASH:case ExpressionTokenizer.T_PERCENT:prec=3;break;case ExpressionTokenizer.T_PLUS:case ExpressionTokenizer.T_DASH:prec=4;break;case ExpressionTokenizer.T_LEFT_OP:case ExpressionTokenizer.T_RIGHT_OP:prec=5;break;case ExpressionTokenizer.T_LEFT_ANGLE:case ExpressionTokenizer.T_RIGHT_ANGLE:case ExpressionTokenizer.T_LE_OP:case ExpressionTokenizer.T_GE_OP:prec=6;break;case ExpressionTokenizer.T_EQ_OP:case ExpressionTokenizer.T_NE_OP:prec=7;break;case ExpressionTokenizer.T_AMPERSAND:prec=8;break;case ExpressionTokenizer.T_XOR_OP:prec=9;break;case ExpressionTokenizer.T_VERTICAL_BAR:prec=10;break;case ExpressionTokenizer.T_AND_OP:prec=11;break;case ExpressionTokenizer.T_OR_OP:prec=12;break;default:return null}if(-1!==p&&prec>=p)return null;tokenizer.next();var rhs=this._parse_expression(tokenizer,prec);if(null===rhs)return null;switch(tok.id){case ExpressionTokenizer.T_STAR:return lhs*rhs;case ExpressionTokenizer.T_SLASH:return lhs/rhs;case ExpressionTokenizer.T_PERCENT:return lhs%rhs;case ExpressionTokenizer.T_PLUS:return lhs+rhs;case ExpressionTokenizer.T_DASH:return lhs-rhs;case ExpressionTokenizer.T_LEFT_OP:return lhs<<rhs;case ExpressionTokenizer.T_RIGHT_OP:return lhs>>rhs;case ExpressionTokenizer.T_LEFT_ANGLE:return rhs>lhs;case ExpressionTokenizer.T_RIGHT_ANGLE:return lhs>rhs;case ExpressionTokenizer.T_LE_OP:return rhs>=lhs;case ExpressionTokenizer.T_GE_OP:return lhs>=rhs;case ExpressionTokenizer.T_EQ_OP:return lhs==rhs;case ExpressionTokenizer.T_NE_OP:return lhs!=rhs;case ExpressionTokenizer.T_AMPERSAND:return lhs&rhs;case ExpressionTokenizer.T_XOR_OP:return lhs^rhs;case ExpressionTokenizer.T_VERTICAL_BAR:return lhs|rhs;case ExpressionTokenizer.T_AND_OP:return lhs&&rhs;case ExpressionTokenizer.T_OR_OP:return lhs||rhs}return null},Preprocessor.prototype._parse_expression_rhs=function(tokenizer,p,lhs){return this._parse_expression_binop(tokenizer,p,lhs)},Preprocessor.prototype._parse_expression=function(tokenizer,p){var lhs=this._parse_expression_primary(tokenizer);if(null!==lhs)for(;;){var ret=this._parse_expression_rhs(tokenizer,p,lhs);if(null===ret)return lhs;lhs=ret}},Preprocessor.prototype._error=function(loc,text){this._errors.push(new glsl.source.Error(loc,text))},Preprocessor.prototype.source=function(){return this._source},exports.Preprocessor=Preprocessor}(ns);var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.ast={},ns=ctx.glsl.ast}else{var glsl={tokenizer:require("./tokenizer"),preprocessor:require("./preprocessor"),source:require("./source")};ns=exports}!function(exports){"use strict";function Error(loc,message){glsl.source.Error.call(this,loc,message)}function Node(){this.incomplete=!0}function TypeRef(tok){Node.call(this),this.token=tok,this.decl=null,this.qualifiers=[],this.is_primitive=null!==tok?tok.id!=Tn.T_IDENTIFIER:!1}function StructDecl(stok){Node.call(this),this.token=stok,this.name=null,this.left_brace=null,this.right_brace=null,this.fields=[]}function FieldDecl(type){Node.call(this),this.type=type,this.names=[],this.semi=null}function PrecisionStmt(token){Node.call(this),this.token=token,this.qualifier=null,this.type=null,this.semi=null}function InvariantDecl(token){Node.call(this),this.token=token,this.names=[],this.semi=null}function VariableDecl(type){Node.call(this),this.type=type,this.names=[],this.semi=null}function TypeDecl(type){Node.call(this),this.type=type,this.semi=null}function ParamDecl(){Node.call(this),this.type=null,this.name=null,this.qualifier=null,this.is_array=!1,this.array_size=null,this.left_bracket=null,this.right_bracket=null}function Named(name,decl){Node.call(this),this.name=name,this.decl=decl,this.type=null,this.initial_assign=null,this.initial_value=null,this.is_array=!1,this.array_size=null,this.left_bracket=null,this.right_bracket=null}function FunctionHeader(type,name){Node.call(this),this.type=type,this.name=name,this.parameters=[],this.left_paren=null,this.right_paren=null}function FunctionProto(header){Node.call(this),this.header=header,this.is_builtin=!1,this.semi=null}function FunctionDef(header){Node.call(this),this.header=header,this.body=null}function Block(){Node.call(this),this.right_brace=null,this.left_brace=null,this.body=[],this.new_scope=!0}function EmptyStmt(semi){Node.call(this),this.semi=semi}function ExpressionStmt(expr){Node.call(this),this.expression=expr,this.semi=null}function ExpressionListStmt(){Node.call(this),this.expressions=[],this.semi=null}function SelectionStmt(tok){Node.call(this),this.token=tok,this.left_paren=null,this.condition=null,this.right_paren=null,this.body=null,this.els=null}function SelectionElseStmt(tok){Node.call(this),this.token=tok,this.body=null}function WhileStmt(tok){Node.call(this),this.token=tok,this.left_paren=null,this.condition=null,this.right_paren=null,this.body=null}function DoStmt(dtok){Node.call(this),this.do_token=dtok,this.while_token=null,this.left_paren=null,this.condition=null,this.right_paren=null,this.body=null}function ForStmt(tok){Node.call(this),this.token=tok,this.left_paren=null,this.init=null,this.rest=null,this.right_paren=null,this.body=null}function ForRestStmt(cond){Node.call(this),this.condition=cond,this.semi=null,this.expression=null}function ContinueStmt(tok){Node.call(this),this.token=tok,this.semi=null}function BreakStmt(tok){Node.call(this),this.token=tok,this.semi=null}function ReturnStmt(tok){Node.call(this),this.token=tok,this.expression=null,this.semi=null}function DiscardStmt(tok){Node.call(this),this.token=tok,this.semi=null}function AssignmentExpr(lexpr){Node.call(this),this.lhs=lexpr,this.op=null,this.rhs=null}function TernaryExpr(condition){Node.call(this),this.condition=condition,this.question_token=null,this.true_expression=null,this.colon_token=null,this.false_expression=null}function BinOpExpr(lhs,op,rhs){Node.call(this),this.lhs=lhs,this.op=op,this.rhs=rhs}function UnaryOpExpr(op,rhs){Node.call(this),this.op=op,this.expression=rhs}function UnaryPostfixOpExpr(op,rhs){Node.call(this),this.op=op,this.expression=rhs}function ConstantExpr(token){Node.call(this),this.token=token}function GroupExpr(){Node.call(this),this.left_paren=null,this.expression=null,this.right_paren=null}function VariableExpr(name){Node.call(this),this.name=name}function FunctionCallExpr(name){Node.call(this),this.name=name,this.left_paren=null,this.right_paren=null,this.arguments=[]}function FieldSelectionExpr(expr,op){Node.call(this),this.expression=expr,this.op=op,this.selector=null}function IndexExpr(expr){Node.call(this),this.expression=expr,this.right_bracket=null,this.index=null,this.left_bracket=null}function NoMatch(tok){Node.call(this),this.token=tok}function Parser(source,type,options){Node.call(this),"undefined"==typeof options&&(options={}),"undefined"==typeof options.preprocessor&&(options.preprocessor={}),this._preprocessor=new glsl.preprocessor.Preprocessor(source,type,options.preprocessor),this._t=new Tn(this._preprocessor),this._errors=[],this.type=type,this.body=[],this.comments=[],this._parse_tu(),this.complete()}function match_one_of(f,oneof){for(var i=0;i<oneof.length;i++){var m=oneof[i];if("undefined"==typeof m)throw new Error(["undefined rule for",f]);if("undefined"==typeof m.expected)throw new Error(["undefined .expected for ",f,m])}f.match=function(tok){return this._match_one_of(oneof,tok)},f.expected=function(){for(var ret=[],i=0;i<oneof.length;i++)ret=ret.concat(oneof[i].expected.call(this));return ret}}var Tn=glsl.tokenizer.Tokenizer,SYNC_FAIL=0,SYNC_OK=1,SYNC_OK_CONSUME=2;Error.prototype=Object.create(glsl.source.Error.prototype),Error.prototype.constructor=Error,exports.Node=Node,Node.create=function(name,constructor,parent){"undefined"==typeof parent&&(parent=Node);var ret=Object.create(parent.prototype);return ret.node_name=name,ret.constructor=constructor,ret},Node.prototype._value_is_empty=function(v){if(null===v)return!0;
if(v===!1)return!0;if(0===v)return!0;if(Array.prototype.isPrototypeOf(v)&&0===v.length)return!0;if(Object.prototype.isPrototypeOf(v)){for(var prop in v)if(v.hasOwnProperty(prop))return!1;return!0}return!1},Node.prototype.complete=function(){return this.incomplete=!1,this},Node.prototype._marshal_object_is_ref=function(value,inctype){if(Node.prototype.isPrototypeOf(value)&&value.marshal_can_ref()&&"undefined"!=typeof value.__marshal_ref_id){value.__marshal_ref++;var ret="";return inctype&&(ret+=value.node_name),ret+"@"+value.__marshal_ref_id}return null},Node.prototype.marshal_node_name=function(){return this.node_name},Node.prototype.marshal_can_ref=function(){return!0},Node.prototype._marshal_object=function(value,ctx){var ret={},isref=this._marshal_object_is_ref(value,!1);if(null!==isref)return isref;Node.prototype.isPrototypeOf(value)&&value.marshal_can_ref()&&(value.__marshal_ref=1,value.__marshal_ref_id=ctx.__marshal_ref_id++,value.__marshalled=ret,ctx.objects.push(value));for(var k in value)if("_"!=k[0]&&value.hasOwnProperty(k)&&!this._value_is_empty(value[k])){var name=k,val=value[k];"object"==typeof val&&"function"==typeof val.marshal_node_name&&(name+="("+val.marshal_node_name()+")"),ret[name]=this._marshal_value(val,ctx)}return ret},Node.prototype._marshal_array=function(value,ctx){for(var ret=new Array(value.length),i=0;i<value.length;i++){var val=value[i];if("object"==typeof val&&Node.prototype.isPrototypeOf(val)){var isref=this._marshal_object_is_ref(val,!0);if(null===isref){var h={};h[val.node_name]=this._marshal_value(val,ctx),ret[i]=h}else ret[i]=isref}else ret[i]=this._marshal_value(val,ctx)}return ret},Node.prototype._marshal_value=function(value,ctx){if("undefined"==typeof value)return"undefined";if("object"!=typeof value)return value;if(Array.prototype.isPrototypeOf(value))return this._marshal_array(value,ctx);var ret=this._marshal_object_is_ref(value,!1);return null===ret&&(ret="function"==typeof value.marshal?value.marshal(ctx):this._marshal_object(value,ctx)),ret},Node.prototype.marshal=function(ctx){var owned_ctx=!1;"undefined"==typeof ctx&&(ctx={__marshal_ref_id:1,objects:[]},owned_ctx=!0);var ret=this._marshal_object(this,ctx);if(owned_ctx)for(var i=0;i<ctx.objects.length;i++){var obj=ctx.objects[i];obj.__marshal_ref>1&&(obj.__marshalled["@id"]=obj.__marshal_ref_id),delete obj.__marshal_ref,delete obj.__marshalled,delete obj.__marshal_ref_id}return ret},Node.prototype.location=function(){throw new Error(this.node_name+" does not implement required location()")},Node.prototype.to_json=function(){return JSON.stringify(this,function(key,value){return"_"==key[0]?null:value})},TypeRef.prototype=Node.create("TypeRef",TypeRef),exports.TypeRef=TypeRef,TypeRef.wrap_decl=function(decl){if(TypeRef.prototype.isPrototypeOf(decl))return decl;var ret=new TypeRef(null);return ret.decl=decl,decl.incomplete||ret.complete(),ret},TypeRef.prototype.location=function(){return glsl.source.Range.spans(this.token,this.qualifiers)},TypeRef.prototype.has_qualifier=function(qid){for(var i=0;i<this.qualifiers.length;i++){var q=this.qualifiers[i];if(q.id==qid)return!0}return!1},TypeRef.prototype.is_const=function(){return this.has_qualifier(Tn.T_CONST)},TypeRef.prototype.is_attribute=function(){return this.has_qualifier(Tn.T_ATTRIBUTE)},TypeRef.prototype.is_varying=function(){return this.has_qualifier(Tn.T_VARYING)},TypeRef.prototype.is_uniform=function(){return this.has_qualifier(Tn.T_UNIFORM)},StructDecl.prototype=Node.create("StructDecl",StructDecl),exports.StructDecl=StructDecl,StructDecl.prototype.location=function(){return glsl.source.Range.spans(this.token,this.name,this.fields,this.left_brace,this.right_brace)},FieldDecl.prototype=Node.create("FieldDecl",FieldDecl),exports.FieldDecl=FieldDecl,FieldDecl.prototype.location=function(){return glsl.source.Range.spans(this.type,this.names,this.semi)},PrecisionStmt.prototype=Node.create("PrecisionStmt",PrecisionStmt),exports.PrecisionStmt=PrecisionStmt,PrecisionStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.qualifier,this.type,this.semi)},InvariantDecl.prototype=Node.create("InvariantDecl",InvariantDecl),exports.InvariantDecl=InvariantDecl,InvariantDecl.prototype.location=function(){return glsl.source.Range.spans(this.token,this.names,this.semi)},VariableDecl.prototype=Node.create("VariableDecl",VariableDecl),exports.VariableDecl=VariableDecl,VariableDecl.prototype.location=function(){return glsl.source.Range.spans(this.type,this.names,this.semi)},TypeDecl.prototype=Node.create("TypeDecl",TypeDecl),exports.TypeDecl=TypeDecl,TypeDecl.prototype.location=function(){return glsl.source.Range.spans(this.type,this.semi)},ParamDecl.prototype=Node.create("ParamDecl",ParamDecl),exports.ParamDecl=ParamDecl,ParamDecl.prototype.location=function(){return glsl.source.Range.spans(this.type,this.name,this.qualifier,this.array_size,this.left_bracket,this.right_bracket)},Named.prototype=Node.create("Named",Named),exports.Named=Named,Named.prototype.location=function(){return glsl.source.Range.spans(this.name,this.initial_assign,this.initial_value,this.array_size,this.left_bracket,this.right_bracket)},FunctionHeader.prototype=Node.create("FunctionHeader",FunctionHeader),exports.FunctionHeader=FunctionHeader,FunctionHeader.prototype.location=function(){return glsl.source.Range.spans(this.type,this.name,this.parameters,this.left_paren,this.right_paren)},FunctionHeader.signature_from_names=function(name,argnames){for(var ret=name+"(",i=0;i<argnames.length;i++){var item=argnames[i];0!==i&&(ret+=","),ret+=item}return ret+")"},FunctionHeader.prototype.signature=function(){for(var argnames=[],i=0;i<this.parameters.length;i++){var param=this.parameters[i];param.type.token.id!=Tn.T_VOID&&argnames.push(param.type.token.text)}return FunctionHeader.signature_from_names(this.name.text,argnames)},FunctionProto.prototype=Node.create("FunctionProto",FunctionProto),exports.FunctionProto=FunctionProto,FunctionProto.prototype.location=function(){return glsl.source.Range.spans(this.header.location(),this.semi)},FunctionDef.prototype=Node.create("FunctionDef",FunctionDef),exports.FunctionDef=FunctionDef,FunctionDef.prototype.location=function(){return glsl.source.Range.spans(this.header,this.body)},Block.prototype=Node.create("Block",Block),exports.Block=Block,Block.prototype.location=function(){return glsl.source.Range.spans(this.right_brace,this.body,this.left_brace)},EmptyStmt.prototype=Node.create("EmptyStmt",EmptyStmt),exports.EmptyStmt=EmptyStmt,EmptyStmt.prototype.location=function(){return this.semi.location.copy()},ExpressionStmt.prototype=Node.create("ExpressionStmt",ExpressionStmt),exports.ExpressionStmt=ExpressionStmt,ExpressionStmt.prototype.location=function(){return glsl.source.Range.spans(this.expression,this.semi)},ExpressionListStmt.prototype=Node.create("ExpressionListStmt",ExpressionListStmt),exports.ExpressionListStmt=ExpressionListStmt,ExpressionListStmt.prototype.location=function(){return glsl.source.Range.spans(this.expressions,this.semi)},SelectionStmt.prototype=Node.create("SelectionStmt",SelectionStmt),exports.SelectionStmt=SelectionStmt,SelectionStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.left_paren,this.condition,this.right_paren,this.body,this.els)},SelectionElseStmt.prototype=Node.create("SelectionElseStmt",SelectionElseStmt),exports.SelectionElseStmt=SelectionElseStmt,SelectionElseStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.body)},WhileStmt.prototype=Node.create("WhileStmt",WhileStmt),exports.WhileStmt=WhileStmt,WhileStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.left_paren,this.condition,this.right_paren,this.body)},DoStmt.prototype=Node.create("DoStmt",DoStmt),exports.DoStmt=DoStmt,DoStmt.prototype.location=function(){return glsl.source.Range.spans(this.do_token,this.while_token,this.left_paren,this.condition,this.right_paren,this.body)},ForStmt.prototype=Node.create("ForStmt",ForStmt),exports.ForStmt=ForStmt,ForStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.left_paren,this.init,this.rest,this.right_paren,this.body)},ForRestStmt.prototype=Node.create("ForRestStmt",ForRestStmt),exports.ForRestStmt=ForRestStmt,ForRestStmt.prototype.location=function(){return glsl.source.Range.spans(this.condition,this.semi,this.expression)},ContinueStmt.prototype=Node.create("ContinueStmt",ContinueStmt),exports.ContinueStmt=ContinueStmt,ContinueStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.semi)},BreakStmt.prototype=Node.create("BreakStmt",BreakStmt),exports.BreakStmt=BreakStmt,BreakStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.semi)},ReturnStmt.prototype=Node.create("ReturnStmt",ReturnStmt),exports.ReturnStmt=ReturnStmt,ReturnStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.expression,this.semi)},DiscardStmt.prototype=Node.create("DiscardStmt",DiscardStmt),exports.DiscardStmt=DiscardStmt,DiscardStmt.prototype.location=function(){return glsl.source.Range.spans(this.token,this.semi)},AssignmentExpr.prototype=Node.create("AssignmentExpr",AssignmentExpr),exports.AssignmentExpr=AssignmentExpr,AssignmentExpr.prototype.location=function(){return glsl.source.Range.spans(this.lhs,this.op,this.rhs)},TernaryExpr.prototype=Node.create("TernaryExpr",TernaryExpr),exports.TernaryExpr=TernaryExpr,TernaryExpr.prototype.location=function(){return glsl.source.Range.spans(this.condition,this.question_token,this.true_expression,this.colon_token,this.false_expression)},BinOpExpr.prototype=Node.create("BinOpExpr",BinOpExpr),exports.BinOpExpr=BinOpExpr,BinOpExpr.prototype.location=function(){return glsl.source.Range.spans(this.lhs,this.op,this.rhs)},UnaryOpExpr.prototype=Node.create("UnaryOpExpr",UnaryOpExpr),exports.UnaryOpExpr=UnaryOpExpr,UnaryOpExpr.prototype.location=function(){return glsl.source.Range.spans(this.op,this.expression)},UnaryPostfixOpExpr.prototype=Node.create("UnaryPostfixOpExpr",UnaryPostfixOpExpr),exports.UnaryPostfixOpExpr=UnaryPostfixOpExpr,UnaryPostfixOpExpr.prototype.location=function(){return glsl.source.Range.spans(this.op,this.expression)},ConstantExpr.prototype=Node.create("ConstantExpr",ConstantExpr),exports.ConstantExpr=ConstantExpr,ConstantExpr.prototype.location=function(){return glsl.source.Range.spans(this.token)},GroupExpr.prototype=Node.create("GroupExpr",GroupExpr),exports.GroupExpr=GroupExpr,GroupExpr.prototype.location=function(){return glsl.source.Range.spans(this.left_paren,this.expression,this.right_paren)},VariableExpr.prototype=Node.create("VariableExpr",VariableExpr),exports.VariableExpr=VariableExpr,VariableExpr.prototype.location=function(){return glsl.source.Range.spans(this.name)},FunctionCallExpr.prototype=Node.create("FunctionCallExpr",FunctionCallExpr),exports.FunctionCallExpr=FunctionCallExpr,FunctionCallExpr.prototype.location=function(){return glsl.source.Range.spans(this.name,this.left_paren,this.right_paren,this.arguments)},FieldSelectionExpr.prototype=Node.create("FieldSelectionExpr",FieldSelectionExpr),exports.FieldSelectionExpr=FieldSelectionExpr,FieldSelectionExpr.prototype.location=function(){return glsl.source.Range.spans(this.expression,this.op,this.selector)},IndexExpr.prototype=Node.create("IndexExpr",IndexExpr),exports.IndexExpr=IndexExpr,IndexExpr.prototype.location=function(){return glsl.source.Range.spans(this.expression,this.right_bracket,this.index,this.left_bracket)},NoMatch.prototype=Node.create("NoMatch",NoMatch),exports.NoMatch=NoMatch,NoMatch.prototype.location=function(){return glsl.source.Range.spans(this.token)},Parser.prototype=Node.create("Parser",Parser),Parser.prototype.marshal=function(ctx){var ret=Node.prototype.marshal.call(this,ctx);return 0!==this._errors.length&&(ret.errors=this._marshal_array(this._errors,ctx)),ret},Parser.prototype._require_one_of_error=function(ids,tok){var loc,got;tok.id==Tn.T_EOF?(loc=this._t.location().to_range(),got="nothing"):(loc=tok.location,got=this._t.token_name(tok.id));for(var choices=[],i=0;i<ids.length;i++)choices.push(this._t.token_name(ids[i]));return choices.length>1?(choices=choices.slice(0,choices.length-1).join(", ")+" or "+choices[choices.length-1],this._error(loc,"expected one of "+choices+", but got "+got)):this._error(loc,"expected "+choices[0]+", but got "+got),this._t.unconsume(tok),null},Parser.prototype._require_one_of=function(ids){for(var tok=this._t.next(),i=0;i<ids.length;i++)if(tok.id==ids[i])return tok;return this._require_one_of_error(ids,tok)},Parser.prototype._match_one_of=function(matchers,tok){for(var retf=function(m,tok){return m.call(this,tok,ret)},i=0;i<matchers.length;i++){var m=matchers[i],ret=this._match(m,tok);if(ret)return retf.bind(this,m)}return!1},Parser.prototype._parse_binop_expression=function(tok,m,expr,opid,rule){var ret;if(ret=rule==this._parse_unary_expression&&"undefined"!=typeof expr?expr:rule.call(this,tok,m,expr),ret.incomplete)return ret;for(tok=this._t.peek();opid(tok.id);){var op=tok;this._t.next();var rhs=this._parse_rule(rule,this._t.next());if(ret=new BinOpExpr(ret,op,rhs),rhs.incomplete)return ret;ret.complete(),tok=this._t.peek()}return ret},Parser.prototype._parse_function_call=function(tok){var cl=new FunctionCallExpr(tok);if(cl.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===cl.left_paren)return cl;var n=this._t.peek();if(this._match(this._parse_assignment_expression,n))for(;;){var ret=this._parse_rule(this._parse_assignment_expression,this._t.next());if(cl.arguments.push(ret),ret.incomplete)return cl;if(n=this._t.peek(),n.id!=Tn.T_COMMA)break;this._t.next()}else n.id==Tn.T_VOID&&(cl.arguments=[this._t.next()]);return cl.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===cl.right_paren?cl:cl.complete()},Parser.prototype._parse_function_identifier=function(tok){return new Named(tok,null).complete()},Parser.prototype._is_primitive_type=function(id){switch(id){case Tn.T_FLOAT:case Tn.T_INT:case Tn.T_BOOL:case Tn.T_VEC2:case Tn.T_VEC3:case Tn.T_VEC4:case Tn.T_BVEC2:case Tn.T_BVEC3:case Tn.T_BVEC4:case Tn.T_IVEC2:case Tn.T_IVEC3:case Tn.T_IVEC4:case Tn.T_MAT2:case Tn.T_MAT3:case Tn.T_MAT4:case Tn.T_SAMPLER2D:case Tn.T_SAMPLERCUBE:return!0}return!1},Parser.prototype._parse_function_identifier.match=function(tok){return this._is_primitive_type(tok.id)||tok.id==Tn.T_IDENTIFIER},Parser.prototype._parse_primary_expression=function(tok){if(this._parse_function_identifier.match.call(this,tok)){var n=this._t.peek();return n.id==Tn.T_LEFT_PAREN?this._parse_function_call(tok):new VariableExpr(tok).complete()}switch(tok.id){case Tn.T_INTCONSTANT:case Tn.T_FLOATCONSTANT:case Tn.T_BOOLCONSTANT:return new ConstantExpr(tok).complete();case Tn.T_LEFT_PAREN:var grp=new GroupExpr;return grp.left_paren=tok,grp.expression=this._parse_rule(this._parse_expression,this._t.next()),grp.expression.incomplete?grp:(grp.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===grp.right_paren?grp:grp.complete())}},Parser.prototype._parse_primary_expression.match=function(tok){switch(tok.id){case Tn.T_INTCONSTANT:case Tn.T_FLOATCONSTANT:case Tn.T_BOOLCONSTANT:case Tn.T_LEFT_PAREN:return!0}return this._match(this._parse_function_identifier,tok)},Parser.prototype._parse_primary_expression.expected=function(){return["identifier","integer","float","bool","grouped expression"]},Parser.prototype._parse_postfix_expression=function(tok,m){var expr=this._parse_primary_expression(tok,m);if(expr.incomplete)return expr;for(tok=this._t.peek();tok.id!=Tn.T_EOF;){switch(tok.id){case Tn.T_LEFT_BRACKET:if(this._t.next(),expr=new IndexExpr(expr),expr.left_bracket=tok,expr.index=this._parse_rule(this._parse_expression,this._t.next()),expr.index.incomplete)break;if(expr.right_bracket=this._require_one_of([Tn.T_RIGHT_BRACKET]),null===expr.right_bracket)break;expr.complete();break;case Tn.T_DOT:if(this._t.next(),expr=new FieldSelectionExpr(expr,tok),expr.selector=this._require_one_of([Tn.T_IDENTIFIER]),null===expr.selector)break;expr.complete();break;case Tn.T_INC_OP:case Tn.T_DEC_OP:this._t.next(),expr=new UnaryPostfixOpExpr(tok,expr).complete();break;default:tok=null}if(null===tok)break;tok=this._t.peek()}return expr},Parser.prototype._parse_postfix_expression.match=Parser.prototype._parse_primary_expression.match,Parser.prototype._parse_postfix_expression.expected=Parser.prototype._parse_primary_expression.expected,Parser.prototype._parse_unary_expression=function(tok,m){switch(tok.id){case Tn.T_INC_OP:case Tn.T_DEC_OP:case Tn.T_PLUS:case Tn.T_DASH:case Tn.T_BANG:case Tn.T_TILDE:var expr=this._parse_rule(this._parse_unary_expression,this._t.next()),ret=new UnaryOpExpr(tok,expr);return expr.incomplete||ret.complete(),ret}return this._parse_postfix_expression(tok,m)},Parser.prototype._parse_unary_expression.match=function(tok){switch(tok.id){case Tn.T_INC_OP:case Tn.T_DEC_OP:case Tn.T_PLUS:case Tn.T_DASH:case Tn.T_BANG:case Tn.T_TILDE:return!0}return this._match(this._parse_postfix_expression,tok)},Parser.prototype._parse_unary_expression.expected=function(){return["unary operator"].concat(this._parse_postfix_expression.expected.call(this))},Parser.prototype._parse_multiplicative_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_STAR||id==Tn.T_SLASH||id==Tn.T_PERCENT},this._parse_unary_expression)},Parser.prototype._parse_multiplicative_expression.match=Parser.prototype._parse_unary_expression.match,Parser.prototype._parse_multiplicative_expression.expected=Parser.prototype._parse_unary_expression.expected,Parser.prototype._parse_additive_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_PLUS||id==Tn.T_DASH},this._parse_multiplicative_expression)},Parser.prototype._parse_additive_expression.match=Parser.prototype._parse_multiplicative_expression.match,Parser.prototype._parse_additive_expression.expected=Parser.prototype._parse_multiplicative_expression.expected,Parser.prototype._parse_shift_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_LEFT_OP||id==Tn.T_RIGHT_OP},this._parse_additive_expression)},Parser.prototype._parse_shift_expression.match=Parser.prototype._parse_additive_expression.match,Parser.prototype._parse_shift_expression.expected=Parser.prototype._parse_additive_expression.expected,Parser.prototype._parse_relational_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_LEFT_ANGLE||id==Tn.T_RIGHT_ANGLE||id==Tn.T_LE_OP||id==Tn.T_GE_OP},this._parse_shift_expression)},Parser.prototype._parse_relational_expression.match=Parser.prototype._parse_shift_expression.match,Parser.prototype._parse_relational_expression.expected=Parser.prototype._parse_shift_expression.expected,Parser.prototype._parse_equality_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_EQ_OP||id==Tn.T_NE_OP},this._parse_relational_expression)},Parser.prototype._parse_equality_expression.match=Parser.prototype._parse_relational_expression.match,Parser.prototype._parse_equality_expression.expected=Parser.prototype._parse_relational_expression.expected,Parser.prototype._parse_and_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_AMPERSAND},this._parse_equality_expression)},Parser.prototype._parse_and_expression.match=Parser.prototype._parse_equality_expression.match,Parser.prototype._parse_and_expression.expected=Parser.prototype._parse_equality_expression.expected,Parser.prototype._parse_exclusive_or_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_CARET},this._parse_and_expression)},Parser.prototype._parse_exclusive_or_expression.match=Parser.prototype._parse_and_expression.match,Parser.prototype._parse_exclusive_or_expression.expected=Parser.prototype._parse_and_expression.expected,Parser.prototype._parse_inclusive_or_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_VERTICAL_BAR},this._parse_exclusive_or_expression)},Parser.prototype._parse_inclusive_or_expression.match=Parser.prototype._parse_exclusive_or_expression.match,Parser.prototype._parse_inclusive_or_expression.expected=Parser.prototype._parse_exclusive_or_expression.expected,Parser.prototype._parse_logical_and_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_AND_OP},this._parse_inclusive_or_expression)},Parser.prototype._parse_logical_and_expression.match=Parser.prototype._parse_inclusive_or_expression.match,Parser.prototype._parse_logical_and_expression.expected=Parser.prototype._parse_inclusive_or_expression.expected,Parser.prototype._parse_logical_xor_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_XOR_OP},this._parse_logical_and_expression)},Parser.prototype._parse_logical_xor_expression.match=Parser.prototype._parse_logical_and_expression.match,Parser.prototype._parse_logical_xor_expression.expected=Parser.prototype._parse_logical_and_expression.expected,Parser.prototype._parse_logical_or_expression=function(tok,m,expr){return this._parse_binop_expression(tok,m,expr,function(id){return id==Tn.T_OR_OP},this._parse_logical_xor_expression)},Parser.prototype._parse_logical_or_expression.match=Parser.prototype._parse_logical_xor_expression.match,Parser.prototype._parse_logical_or_expression.expected=Parser.prototype._parse_logical_xor_expression.expected,Parser.prototype._parse_unary_conditional_expression_rest=function(expr){if(expr.incomplete)return expr;var n=this._t.peek();if(n.id==Tn.T_QUESTION){var ret=new TernaryExpr(expr);return ret.question_token=this._t.next(),ret.true_expression=this._parse_rule(this._parse_expression,this._t.next()),ret.true_expression.incomplete?ret:(ret.colon_token=this._require_one_of([Tn.T_COLON]),null===ret.colon_token?ret:(ret.false_expression=this._parse_rule(this._parse_assignment_expression,this._t.next()),ret.false_expression.incomplete?ret:ret.complete()))}return expr},Parser.prototype._parse_unary_conditional_expression=function(expr){var tok,m,expr=this._parse_logical_or_expression(tok,m,expr);return this._parse_unary_conditional_expression_rest(expr)},Parser.prototype._parse_conditional_expression=function(tok,m){var expr=this._parse_logical_or_expression(tok,m);return this._parse_unary_conditional_expression_rest(expr)},Parser.prototype._parse_conditional_expression.match=Parser.prototype._parse_logical_or_expression.match,Parser.prototype._parse_conditional_expression.expected=Parser.prototype._parse_logical_or_expression.expected,Parser.prototype._parse_assignment_operator=function(tok){return{token:tok,incomplete:!1}},Parser.prototype._parse_assignment_operator.match=function(tok){switch(tok.id){case Tn.T_EQUAL:case Tn.T_MUL_ASSIGN:case Tn.T_DIV_ASSIGN:case Tn.T_MOD_ASSIGN:case Tn.T_ADD_ASSIGN:case Tn.T_SUB_ASSIGN:case Tn.T_LEFT_ASSIGN:case Tn.T_RIGHT_ASSIGN:case Tn.T_AND_ASSIGN:case Tn.T_XOR_ASSIGN:case Tn.T_OR_ASSIGN:return!0}return!1},Parser.prototype._parse_assignment_operator.expected=function(){return["assignment operator"]},Parser.prototype._parse_unary_assignment_expression=function(expr){var ret=new AssignmentExpr(expr),op=this._parse_rule(this._parse_assignment_operator,this._t.next());return op.incomplete?ret:(ret.op=op.token,ret.rhs=this._parse_rule(this._parse_assignment_expression,this._t.next()),ret.rhs.incomplete||ret.complete(),ret)},Parser.prototype._parse_unary_assignment_expression.match=Parser.prototype._parse_unary_expression.match,Parser.prototype._parse_unary_assignment_expression.expected=Parser.prototype._parse_unary_expression.expected,Parser.prototype._parse_assignment_expression=function(tok,m){var expr=this._parse_unary_expression(tok,m);if(expr.incomplete)return expr;var n=this._t.peek(),m=this._match(this._parse_assignment_operator,n);return m?this._parse_unary_assignment_expression(expr):this._parse_unary_conditional_expression(expr)},Parser.prototype._parse_assignment_expression.match=Parser.prototype._parse_unary_expression.match,Parser.prototype._parse_assignment_expression.expected=Parser.prototype._parse_unary_expression.expected,Parser.prototype._parse_expression=function(tok,m){var expr=this._parse_assignment_expression(tok,m);if(expr.incomplete)return expr;if(tok=this._t.peek(),tok.id!=Tn.T_COMMA)return expr;var ret=new ExpressionListStmt;for(ret.expressions.push(expr);tok.id==Tn.T_COMMA;){if(this._t.next(),tok=this._t.next(),expr=this._parse_assignment_expression(tok,m),ret.expressions.push(expr),expr.incomplete)return expr;tok=this._t.peek()}return ret.complete()},Parser.prototype._parse_expression.match=Parser.prototype._parse_assignment_expression.match,Parser.prototype._parse_expression.expected=Parser.prototype._parse_assignment_expression.expected,Parser.prototype._parse_constant_expression=Parser.prototype._parse_conditional_expression,Parser.prototype._parse_constant_expression.match=Parser.prototype._parse_conditional_expression.match,Parser.prototype._parse_constant_expression.expected=Parser.prototype._parse_conditional_expression.expected,Parser.prototype._parse_field_declaration_name=function(tok){var name=tok,ret=new Named(name,null);return ret.complete(),this._parse_optional_array_spec(ret),ret},Parser.prototype._parse_field_declaration_name.match=function(tok){return tok.id==Tn.T_IDENTIFIER},Parser.prototype._parse_field_declaration_name.expected=function(){return["field name"]},Parser.prototype._parse_field_declaration=function(tok,m){var type=m(tok),sdecl=new FieldDecl(type);if(type.incomplete)return sdecl;tok=this._t.next();for(var first=!0;tok.id!=Tn.T_EOF&&tok.id!=Tn.T_SEMICOLON;){if(first)first=!1;else{if(tok.id!=Tn.T_COMMA)return this._require_one_of_error([Tn.T_COMMA],tok),sdecl;tok=this._t.next()}var fname=this._parse_rule(this._parse_field_declaration_name,tok);if(fname.decl=sdecl,fname.type=type,sdecl.names.push(fname),fname.incomplete)return sdecl;tok=this._t.next()}return tok.id!=Tn.T_SEMICOLON?(this._require_one_of_error([Tn.T_SEMICOLON],tok),sdecl):(sdecl.semi=tok,sdecl.complete())},Parser.prototype._parse_struct_specifier=function(tok){var lb=this._t.next(),sdl=new StructDecl(tok);if(lb.id!=Tn.T_IDENTIFIER&&lb.id!=Tn.T_LEFT_BRACE)return this._require_one_of_error([Tn.T_IDENTIFIER,Tn.T_LEFT_BRACE],lb),sdl;var name=null;if(lb.id==Tn.T_IDENTIFIER&&(name=lb,lb=this._t.next()),sdl.name=name,lb.id!=Tn.T_LEFT_BRACE)return this._require_one_of_error([Tn.T_LEFT_BRACE],lb),sdl;for(sdl.left_brace=lb,tok=this._t.next();tok.id!=Tn.T_EOF&&tok.id!=Tn.T_RIGHT_BRACE;){var decl=this._parse_rule(this._parse_field_declaration,tok);if(sdl.fields.push(decl),decl.incomplete)return sdl;tok=this._t.next()}return tok.id!=Tn.T_RIGHT_BRACE?(this._require_one_of_error([Tn.T_RIGHT_BRACE],tok),sdl):(sdl.right_brace=tok,sdl.complete())},Parser.prototype._parse_struct_specifier.match=function(tok){return tok.id==Tn.T_STRUCT},Parser.prototype._parse_type_specifier_no_prec_impl=function(tok){return new TypeRef(tok).complete()},Parser.prototype._parse_type_specifier_no_prec=function(tok,m){return m(tok)},Parser.prototype._parse_type_specifier_no_prec.match=function(tok){switch(tok.id){case Tn.T_VOID:case Tn.T_FLOAT:case Tn.T_INT:case Tn.T_BOOL:case Tn.T_VEC2:case Tn.T_VEC3:case Tn.T_VEC4:case Tn.T_BVEC2:case Tn.T_BVEC3:case Tn.T_BVEC4:case Tn.T_IVEC2:case Tn.T_IVEC3:case Tn.T_IVEC4:case Tn.T_MAT2:case Tn.T_MAT3:case Tn.T_MAT4:case Tn.T_SAMPLER2D:case Tn.T_SAMPLERCUBE:case Tn.T_IDENTIFIER:return this._parse_type_specifier_no_prec_impl}return this._match(this._parse_struct_specifier,tok)?this._parse_struct_specifier.bind(this):void 0},Parser.prototype._parse_type_specifier_no_prec.expected=function(){return["builtin type","user type identifier"]},Parser.prototype._parse_type_specifier=function(tok,m){return m(tok)},Parser.prototype._parse_precision_qualifier=function(tok){return tok},Parser.prototype._parse_precision_qualifier.match=function(tok){switch(tok.id){case Tn.T_HIGH_PRECISION:case Tn.T_MEDIUM_PRECISION:case Tn.T_LOW_PRECISION:return!0}return!1},Parser.prototype._parse_precision_qualifier.expected=function(){return["highp","mediump","lowp"]},Parser.prototype._parse_type_precision_qualifier=function(tok){var type=this._parse_rule(this._parse_type_specifier_no_prec,this._t.next());return type=TypeRef.wrap_decl(type),type.qualifiers.unshift(tok),type},Parser.prototype._parse_type_precision_qualifier.match=Parser.prototype._parse_precision_qualifier.match,Parser.prototype._parse_type_precision_qualifier.expected=Parser.prototype._parse_precision_qualifier.expected,match_one_of(Parser.prototype._parse_type_specifier,[Parser.prototype._parse_type_specifier_no_prec,Parser.prototype._parse_type_precision_qualifier]),Parser.prototype._parse_field_declaration.match=Parser.prototype._parse_type_specifier.match,Parser.prototype._parse_type_qualifier=function(tok){var node;if(tok.id==Tn.T_INVARIANT){var varying=this._require_one_of([Tn.T_VARYING]);node=null===varying?new TypeRef(null):this._parse_rule(this._parse_type_specifier,this._t.next()),node.qualifiers.unshift(varying)}else node=this._parse_rule(this._parse_type_specifier,this._t.next()),node=TypeRef.wrap_decl(node);return node&&node.qualifiers.unshift(tok),node},Parser.prototype._parse_type_qualifier.match=function(tok){switch(tok.id){case Tn.T_CONST:case Tn.T_ATTRIBUTE:case Tn.T_VARYING:case Tn.T_INVARIANT:case Tn.T_UNIFORM:return!0}},Parser.prototype._parse_type_qualifier.expected=function(){return["const","attribute","varying","invariant","uniform"]},Parser.prototype._parse_fully_specified_type=function(tok,m){return m(tok)},match_one_of(Parser.prototype._parse_fully_specified_type,[Parser.prototype._parse_type_specifier,Parser.prototype._parse_type_qualifier]),Parser.prototype._parse_optional_array_spec=function(ret){var tok=this._t.peek();return tok.id==Tn.T_LEFT_BRACKET?(ret.is_array=!0,ret.left_bracket=tok,this._t.next(),ret.array_size=this._parse_rule(this._parse_constant_expression,this._t.next()),ret.array_size.incomplete?(ret.incomplete=!0,!0):(ret.right_bracket=this._require_one_of([Tn.T_RIGHT_BRACKET]),null===ret.right_bracket?(ret.incomplete=!0,!0):!0)):!1},Parser.prototype._parse_parameter_declarator=function(tok,m){var type=this._parse_type_specifier(tok,m),pdecl=new ParamDecl;return pdecl.type=type,type.incomplete?pdecl:(tok=this._t.peek(),tok.id==Tn.T_IDENTIFIER&&(pdecl.name=this._t.next()),pdecl.complete(),this._parse_optional_array_spec(pdecl),pdecl)},Parser.prototype._parse_parameter_declarator.match=Parser.prototype._parse_type_specifier.match,Parser.prototype._parse_parameter_declarator.expected=Parser.prototype._parse_type_specifier.expected,Parser.prototype._parse_parameter_qualifier=function(tok){var ret=this._parse_rule(this._parse_parameter_declarator,this._t.next());return ret.qualifier=tok,ret},Parser.prototype._parse_parameter_qualifier.match=function(tok){switch(tok.id){case Tn.T_IN:case Tn.T_OUT:case Tn.T_INOUT:return!0}return!1},Parser.prototype._parse_parameter_qualifier.expected=function(){return["in","out","inout"]},Parser.prototype._parse_parameter_type_qualifier=function(tok,m){var q=tok;tok=this._t.next(),m=this._match(this._parse_parameter_qualifier,tok);var decl;return decl=m?this._parse_parameter_qualifier(tok,m):this._parse_rule(this._parse_parameter_declarator,tok),decl.qualifier=q,decl},Parser.prototype._parse_parameter_type_qualifier.match=function(tok){return tok.id==Tn.T_CONST},Parser.prototype._parse_parameter_type_qualifier.expected=function(){return["const"]},Parser.prototype._parse_parameter_declaration=function(tok,m){return m(tok)},match_one_of(Parser.prototype._parse_parameter_declaration,[Parser.prototype._parse_parameter_type_qualifier,Parser.prototype._parse_parameter_qualifier,Parser.prototype._parse_parameter_declarator]),Parser.prototype._parse_function_header=function(type,name){var func=new FunctionHeader(type,name);
if(func.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===func.left_paren)return!1;for(var tok=this._t.next(),first=!0;tok.id!=Tn.T_EOF&&tok.id!=Tn.T_RIGHT_PAREN;){if(first)first=!1;else{if(tok.id!=Tn.T_COMMA)return this._require_one_of_error([Tn.T_COMMA],tok),func;tok=this._t.next()}var m=this._parse_rule(this._parse_parameter_declaration,tok);if(func.parameters.push(m),m.incomplete)return func;tok=this._t.next()}return tok.id!=Tn.T_RIGHT_PAREN?(this._require_one_of_error([Tn.T_RIGHT_PAREN],tok),func):(func.right_paren=tok,func.complete())},Parser.prototype._sync_statement=function(tok){if(this._is_primitive_type(tok.id))return SYNC_OK;switch(tok.id){case Tn.T_SEMICOLON:return SYNC_OK_CONSUME;case Tn.T_PRECISION:case Tn.T_ATTRIBUTE:case Tn.T_CONST:case Tn.T_UNIFORM:case Tn.T_VARYING:case Tn.T_STRUCT:case Tn.T_HIGH_PRECISION:case Tn.T_MEDIUM_PRECISION:case Tn.T_LOW_PRECISION:case Tn.T_PRECISION:case Tn.T_RIGHT_BRACE:case Tn.T_FOR:case Tn.T_DO:case Tn.T_WHILE:case Tn.T_IF:case Tn.T_RETURN:case Tn.T_DISCARD:case Tn.T_CONTINUE:case Tn.T_BREAK:return SYNC_OK}return SYNC_FAIL},Parser.prototype._parse_function_definition=function(header,lb){var func=new FunctionDef(header);if(header.incomplete)return func;func.body=new Block,func.body.left_brace=lb;for(var tok=this._t.next();tok.id!=Tn.T_EOF&&tok.id!=Tn.T_RIGHT_BRACE;){var ret=this._parse_rule(this._parse_statement_no_new_scope,tok);func.body.body.push(ret),ret.incomplete&&this._sync(this._sync_statement),tok=this._t.next()}return tok.id!=Tn.T_RIGHT_BRACE?(this._require_one_of_error([Tn.T_RIGHT_BRACE],tok),func):(func.body.right_brace=tok,func.body.complete(),func.complete())},Parser.prototype._parse_function_prototype_or_definition=function(type,ident){var ret=this._parse_function_header(type,ident);if(ret.incomplete)return new FunctionDef(ret);var n=this._require_one_of([Tn.T_SEMICOLON,Tn.T_LEFT_BRACE]);if(null===n)return new FunctionDef(ret);if(n.id==Tn.T_SEMICOLON){var proto=new FunctionProto(ret);return proto.semi=n,proto.complete()}return this._parse_function_definition(ret,n)},Parser.prototype._parse_statement_with_scope=function(tok,m){return m(tok)},Parser.prototype._parse_selection_rest_statement=function(tok,m){var stmt=this._parse_statement_with_scope(tok,m),ret={body:stmt,els:null,incomplete:!0};if(stmt.incomplete)return ret;var n=this._t.peek();if(n.id==Tn.T_ELSE){var selelse=new SelectionElseStmt(n);ret.els=selelse,this._t.next(),selelse.body=this._parse_rule(this._parse_statement_with_scope,this._t.next()),selelse.body.incomplete||(selelse.complete(),ret.incomplete=!1)}else ret.incomplete=!1;return ret},Parser.prototype._parse_selection_statement=function(tok){var sel=new SelectionStmt(tok);if(sel.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===sel.left_paren)return sel;if(tok=this._t.next(),sel.condition=this._parse_rule(this._parse_expression,tok),sel.condition.incomplete)return sel;if(sel.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===sel.right_paren)return sel;tok=this._t.next();var ret=this._parse_rule(this._parse_selection_rest_statement,tok);return sel.body=ret.body,sel.els=ret.els,ret.incomplete||sel.complete(),sel},Parser.prototype._parse_selection_statement.match=function(tok){return tok.id==Tn.T_IF},Parser.prototype._parse_selection_statement.expected=function(){return["if"]},Parser.prototype._parse_condition_var_init=function(tok,m){var type=this._parse_fully_specified_type(tok,m);type=TypeRef.wrap_decl(type);var ret=new VariableDecl(type);if(type.incomplete)return ret;var ident=this._require_one_of([Tn.T_IDENTIFIER]);if(null===ident)return ret;var equal=this._require_one_of([Tn.T_EQUAL]);if(null===equal)return ret;var named=new Named(ident,ret);named.type=type,ret.names.push(named),named.initial_assign=equal;var init=this._parse_rule(this._parse_initializer,this._t.next());return named.initial_value=init,init.incomplete||(named.complete(),ret.complete()),ret},Parser.prototype._parse_condition_var_init.match=Parser.prototype._parse_fully_specified_type.match,Parser.prototype._parse_condition_var_init.expected=Parser.prototype._parse_fully_specified_type.expected,Parser.prototype._parse_condition=function(tok,m){if(tok.id==Tn.T_IDENTIFIER){var n=this._t.peek();return n.id==Tn.T_IDENTIFIER?this._parse_condition_var_init(tok,this._match(this._parse_condition_var_init,tok)):this._parse_rule(this._parse_expression,tok)}return m(tok)},match_one_of(Parser.prototype._parse_condition,[Parser.prototype._parse_condition_var_init,Parser.prototype._parse_expression]),Parser.prototype._parse_condition.expected=function(){return["condition expression"]},Parser.prototype._parse_while_statement=function(tok){var ret=new WhileStmt(tok);return ret.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===ret.left_paren?ret:(tok=this._t.next(),ret.condition=this._parse_rule(this._parse_condition,tok),ret.condition.incomplete?ret:(ret.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===ret.right_paren?ret:(ret.body=this._parse_rule(this._parse_statement_no_new_scope,this._t.next()),ret.body.incomplete||ret.complete(),ret)))},Parser.prototype._parse_while_statement.match=function(tok){return tok.id==Tn.T_WHILE},Parser.prototype._parse_while_statement.expected=function(){return["while"]},Parser.prototype._parse_do_statement=function(tok){var ret=new DoStmt(tok),stmt=this._parse_rule(this._parse_statement_with_scope,this._t.next());return ret.body=stmt,stmt.incomplete?ret:(ret.while_token=this._require_one_of([Tn.T_WHILE]),null===ret.while_token?ret:(ret.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===ret.left_paren?ret:(tok=this._t.next(),ret.condition=this._parse_rule(this._parse_expression,tok),ret.condition.incomplete?ret:(ret.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===ret.right_paren?ret:(ret.semi=this._require_one_of([Tn.T_SEMICOLON]),null===ret.semi?ret:ret.complete())))))},Parser.prototype._parse_do_statement.match=function(tok){return tok.id==Tn.T_DO},Parser.prototype._parse_do_statement.expected=function(){return["do"]},Parser.prototype._parse_declaration_or_expression_statement=function(tok,m){if(tok.id==Tn.T_IDENTIFIER){var n=this._t.peek();return n.id==Tn.T_IDENTIFIER?this._parse_declaration(tok,this._match(this._parse_declaration,tok)):this._parse_expression_statement(tok,this._match(this._parse_expression_statement,tok))}if(this._match(this._parse_function_identifier,tok)){var n=this._t.peek();if(n.id==Tn.T_LEFT_PAREN)return this._parse_rule(this._parse_expression_statement,tok)}var m=this._match(this._parse_declaration,tok);return m?this._parse_declaration(tok,m):this._parse_rule(this._parse_expression_statement,tok)},Parser.prototype._parse_declaration_or_expression_statement.match=function(tok){var m=this._match(this._parse_declaration,tok);return m||(m=this._match(this._parse_expression_statement,tok)),m},Parser.prototype._parse_declaration_or_expression_statement.expected=function(){return["declaration","expression"]},Parser.prototype._parse_for_init_statement=function(tok,m){return this._parse_declaration_or_expression_statement(tok,m)},Parser.prototype._parse_for_init_statement.match=Parser.prototype._parse_declaration_or_expression_statement.match,Parser.prototype._parse_conditionopt=function(tok,m){return m=this._match(this._parse_condition,tok),m?this._parse_condition(tok,m):null},Parser.prototype._parse_conditionopt.match=function(){return!0},Parser.prototype._parse_for_rest_statement=function(tok,m){var copt=this._parse_rule(this._parse_conditionopt,tok),ret=new ForRestStmt(copt);if(null!==copt&&copt.incomplete)return ret;if(ret.semi=this._require_one_of([Tn.T_SEMICOLON]),null===ret.semi)return ret;var n=this._t.peek(),m=this._match(this._parse_expression,n);return m&&(ret.expression=this._parse_expression(this._t.next(),m),ret.expression.incomplete)?ret:ret.complete()},Parser.prototype._parse_for_rest_statement.match=Parser.prototype._parse_conditionopt.match,Parser.prototype._parse_for_statement=function(tok){var ret=new ForStmt(tok);return ret.left_paren=this._require_one_of([Tn.T_LEFT_PAREN]),null===ret.left_paren?ret:(tok=this._t.next(),ret.init=this._parse_rule(this._parse_for_init_statement,tok),ret.init.incomplete?ret:(tok=this._t.next(),ret.rest=this._parse_rule(this._parse_for_rest_statement,tok),ret.rest.incomplete?ret:(ret.right_paren=this._require_one_of([Tn.T_RIGHT_PAREN]),null===ret.right_paren?ret:(ret.body=this._parse_rule(this._parse_statement_no_new_scope,this._t.next()),ret.body.incomplete?ret:ret.complete()))))},Parser.prototype._parse_for_statement.match=function(tok){return tok.id==Tn.T_FOR},Parser.prototype._parse_for_statement.expected=function(){return["for"]},Parser.prototype._parse_iteration_statement=function(tok,m){return m(tok)},match_one_of(Parser.prototype._parse_iteration_statement,[Parser.prototype._parse_while_statement,Parser.prototype._parse_do_statement,Parser.prototype._parse_for_statement]),Parser.prototype._parse_jump_statement=function(tok){var ret=null;switch(tok.id){case Tn.T_CONTINUE:ret=new ContinueStmt(tok);break;case Tn.T_BREAK:ret=new BreakStmt(tok);break;case Tn.T_RETURN:ret=new ReturnStmt(tok);var n=this._t.peek();if(null!==n&&n.id!=Tn.T_SEMICOLON&&(ret.expression=this._parse_rule(this._parse_expression,this._t.next()),ret.expression.incomplete))return ret;break;case Tn.T_DISCARD:return ret=new DiscardStmt(tok),ret.semi=this._require_one_of([Tn.T_SEMICOLON]),this.type!==glsl.source.FRAGMENT?(this._error(tok.location,"invalid use of discard outside of fragment shader"),ret):ret.complete()}return ret.semi=this._require_one_of([Tn.T_SEMICOLON]),null===ret.semi?ret:ret.complete()},Parser.prototype._parse_jump_statement.match=function(tok){switch(tok.id){case Tn.T_CONTINUE:case Tn.T_BREAK:case Tn.T_RETURN:case Tn.T_DISCARD:return!0}return!1},Parser.prototype._parse_jump_statement.expected=function(){return["continue","break","return","discard"]},Parser.prototype._parse_simple_statement=function(tok,m){return m(tok)},match_one_of(Parser.prototype._parse_simple_statement,[Parser.prototype._parse_declaration_or_expression_statement,Parser.prototype._parse_selection_statement,Parser.prototype._parse_iteration_statement,Parser.prototype._parse_jump_statement]),Parser.prototype._parse_compound_statement=function(tok,newscope){var block=new Block;for(block.new_scope=newscope,block.left_brace=tok,tok=this._t.next();tok.id!=Tn.T_EOF&&tok.id!=Tn.T_RIGHT_BRACE;){var ret=this._parse_rule(this._parse_statement_no_new_scope,tok);if(block.body.push(ret),ret.incomplete)return ret;tok=this._t.next()}return tok.id!=Tn.T_RIGHT_BRACE?(this._require_one_of_error([Tn.T_RIGHT_BRACE],tok),block):(block.right_brace=tok,block.complete())},Parser.prototype._parse_compound_statement_with_scope=function(tok){return this._parse_compound_statement(tok,!0)},Parser.prototype._parse_compound_statement_with_scope.match=function(tok){return tok.id==Tn.T_LEFT_BRACE},Parser.prototype._parse_compound_statement_with_scope.expected=function(){return["opening curly brace {"]},Parser.prototype._parse_compound_statement_no_new_scope=function(tok){return this._parse_compound_statement(tok,!1)},Parser.prototype._parse_compound_statement_no_new_scope.match=function(tok){return tok.id==Tn.T_LEFT_BRACE},Parser.prototype._parse_compound_statement_no_new_scope.expected=function(){return["opening scope brace {"]},Parser.prototype._parse_statement_no_new_scope=function(tok,m){return m(tok)},match_one_of(Parser.prototype._parse_statement_no_new_scope,[Parser.prototype._parse_compound_statement_with_scope,Parser.prototype._parse_simple_statement]),match_one_of(Parser.prototype._parse_statement_with_scope,[Parser.prototype._parse_compound_statement_no_new_scope,Parser.prototype._parse_simple_statement]),Parser.prototype._parse_selection_rest_statement.match=Parser.prototype._parse_statement_with_scope.match,Parser.prototype._parse_selection_rest_statement.expected=Parser.prototype._parse_statement_with_scope.expected,Parser.prototype._parse_declaration_precision=function(tok){var ret=new PrecisionStmt(tok);return ret.qualifier=this._parse_rule(this._parse_precision_qualifier,this._t.next()),ret.qualifier.incomplete?ret:(ret.type=this._parse_rule(this._parse_type_specifier_no_prec,this._t.next()),ret.type.incomplete?ret:(ret.semi=this._require_one_of([Tn.T_SEMICOLON]),null===ret.semi?ret:ret.complete()))},Parser.prototype._parse_initializer=Parser.prototype._parse_assignment_expression,Parser.prototype._parse_initializer.match=Parser.prototype._parse_assignment_expression.match,Parser.prototype._parse_initializer.expected=Parser.prototype._parse_assignment_expression.expected,Parser.prototype._parse_single_declaration=function(type,ident){type=TypeRef.wrap_decl(type);var decl=new VariableDecl(type);if(type.incomplete)return decl;var named=new Named(ident,decl);named.type=type,decl.names.push(named.complete());var n=this._t.peek();if(n.id==Tn.T_EOF)return decl.complete();if(n.id==Tn.T_EQUAL){if(this._t.next(),named.initial_assign=n,named.initial_value=this._parse_rule(this._parse_initializer,this._t.next()),named.initial_value.incomplete)return named.incomplete=!0,decl}else if(this._parse_optional_array_spec(named),named.incomplete)return decl;return decl.complete()},Parser.prototype._parse_init_declarator_list=function(decl,opts){if(decl.incomplete)return decl;decl.incomplete=!0;for(var tok=this._t.peek();tok.id==Tn.T_COMMA;){this._t.next();var ident=this._require_one_of([Tn.T_IDENTIFIER]);if(null===ident)return decl;if(opts.array||opts.equal){var name=new Named(ident,decl);name.type=decl.type,decl.names.push(name);var isarray=!1;if(tok=this._t.peek(),opts.array&&(name.complete(),this._parse_optional_array_spec(name)&&(isarray=!0),name.incomplete))return decl;if(!isarray&&opts.equal&&tok.id==Tn.T_EQUAL&&(this._t.next(),name.initial_value=this._parse_rule(this._parse_initializer,this._t.next()),name.initial_assign=tok,name.initial_value.incomplete))return decl;name.complete()}else decl.names.push(ident);tok=this._t.peek()}return decl.semi=this._require_one_of([Tn.T_SEMICOLON]),null===decl.semi?decl:decl.complete()},Parser.prototype._parse_declaration=function(tok,m){var decl=null,opts={equal:!0,array:!0};if(tok.id==Tn.T_PRECISION)return this._parse_declaration_precision(tok);if(tok.id==Tn.T_INVARIANT){var n=this._t.peek();n.id==Tn.T_IDENTIFIER&&(decl=new InvariantDecl(tok),decl.names.push(this._t.next()),opts.equal=!1,opts.array=!1)}if(null===decl){var type=m(tok),ident=this._t.peek();if(ident.id==Tn.T_IDENTIFIER){this._t.next();var n=this._t.peek();if(n.id==Tn.T_LEFT_PAREN)return this._parse_function_prototype_or_definition(type,ident);decl=this._parse_single_declaration(type,ident)}else decl=new TypeDecl(type),type.incomplete||decl.complete()}else decl.complete();return this._parse_init_declarator_list(decl,opts)},Parser.prototype._parse_declaration.match=function(tok){return tok.id==Tn.T_PRECISION?!0:this._match(this._parse_fully_specified_type,tok)},Parser.prototype._parse_declaration.expected=function(){return["function prototype","function definition","struct declaration","variable declaration"]},Parser.prototype._parse_expression_statement=function(tok,m){if(tok.id==Tn.T_SEMICOLON)return new EmptyStmt(tok).complete();var ret=this._parse_expression(tok,m),stmt=new ExpressionStmt(ret);return ret.incomplete?stmt:(stmt.semi=this._require_one_of([Tn.T_SEMICOLON]),null===stmt.semi?stmt:stmt.complete())},Parser.prototype._parse_expression_statement.match=function(tok){return tok.id==Tn.T_SEMICOLON?!0:this._match(this._parse_expression,tok)},Parser.prototype._parse_external_declaration=function(tok,m){return m(tok)},Parser.prototype._sync_declaration=function(tok){if(this._is_primitive_type(tok.id))return SYNC_OK;switch(tok.id){case Tn.T_SEMICOLON:return SYNC_OK_CONSUME;case Tn.T_PRECISION:case Tn.T_ATTRIBUTE:case Tn.T_CONST:case Tn.T_UNIFORM:case Tn.T_VARYING:case Tn.T_STRUCT:case Tn.T_VOID:case Tn.T_INVARIANT:case Tn.T_HIGH_PRECISION:case Tn.T_MEDIUM_PRECISION:case Tn.T_LOW_PRECISION:case Tn.T_PRECISION:return SYNC_OK}return SYNC_FAIL},Parser.prototype._sync=function(syncer){for(var tok=this._t.peek();tok.id!=Tn.T_EOF;){var s=syncer.call(this,tok);if(s==SYNC_OK)return;if(s==SYNC_OK_CONSUME)return void this._t.next();this._t.next(),tok=this._t.peek()}},match_one_of(Parser.prototype._parse_external_declaration,[Parser.prototype._parse_declaration]),Parser.prototype._parse_tu=function(){for(;!this._t.eof();){var tok=this._t.next();if(tok.id==Tn.T_EOF){this.comments=tok.comments;break}var node=this._parse_rule(this._parse_external_declaration,tok);this.body.push(node),node.incomplete&&this._sync(this._sync_declaration)}},Parser.prototype._error=function(loc,message){this._errors.push(new Error(loc,message))},Parser.prototype._match=function(rule,tok){return rule.match.call(this,tok)},Parser.prototype._parse_rule=function(rule,tok){if("undefined"==typeof tok)return!1;var m=this._match(rule,tok);if(!m){var ex=rule.expected.call(this);return ex=ex.length>1?"`"+ex.slice(0,ex.length-1).join("', `")+"' or `"+ex[ex.length-1]+"'":"`"+ex[0]+"'",this._error(tok.location,"expected "+ex+" but got `"+this._t.token_name(tok.id)+"'"),this._t.unconsume(tok),new NoMatch(tok)}return rule.call(this,tok,m)},Parser.prototype.errors=function(){return this._preprocessor.errors().concat(this._errors)},exports.Parser=Parser}(ns);var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.builtins={},ns=ctx.glsl.builtins}else{var glsl={source:require("./source"),ast:require("./ast"),tokenizer:require("./tokenizer")};ns=exports}!function(exports){"use strict";function TypeClass(name){glsl.ast.Node.call(this),this.incomplete=!1,this.name=name,this.is_primitive=!1,this.is_array=!1,this.is_composite=!1,this.is_user=!1,this.decl=null}function CompositeType(name){TypeClass.call(this,name),this.field_map={},this.fields=[],this.is_composite=!0,this.has_array_field=!1,this.has_sampler_field=!1,this.zero={}}function UserType(name,decl){CompositeType.call(this,name),this.decl=decl,this.is_user=!0}function ArrayType(element_type,length){TypeClass.call(this,element_type.name+"["+length+"]"),this.element_type=element_type,this.length=length,this.zero=[];for(var i=0;length>i;i++)this.zero.push(element_type.zero);this.is_array=!0}function PrimitiveType(id,zero){TypeClass.call(this,dtn.token_name(id)),this.id=id,this.zero=zero,this.is_scalar=PrimitiveType._is_scalar(id),this.is_vec=PrimitiveType._is_vec(id),this.is_mat=PrimitiveType._is_mat(id),this.is_sampler=PrimitiveType._is_sampler(id),this.element_type=PrimitiveType._element_type(id),this.is_int=this.element_type==Tn.T_INT,this.is_float=this.element_type==Tn.T_FLOAT,this.is_bool=this.element_type==Tn.T_BOOL,this.is_primitive=!0,this.length=PrimitiveType._length(id)}function Operator(op){this.op=op,this.ret=null,this.lhs=null,this.rhs=null}function UnaryOperator(op){this.op=op,this.ret=null,this.expr=null}function Builtins(type,options){this.type=type,"undefined"==typeof options&&(options={}),this._options=options,this.types=[],this.type_map={},this.variables=[],this.variable_map={},this.functions=[],this.function_map={},this.operators=[],this.operator_map={},this._define_types(),this._define_constants(),this._define_variables(),this._define_functions(),this._define_operators()}var Tn=glsl.tokenizer.Tokenizer,dtn=new Tn(null);TypeClass.prototype=glsl.ast.Node.create("TypeClass",TypeClass),exports.TypeClass=TypeClass,CompositeType.prototype=glsl.ast.Node.create("builtins.CompositeType",CompositeType,TypeClass),exports.CompositeType=CompositeType,CompositeType.prototype.declare_field=function(name,type){var field={name:name,type:type,decl:null};return(type.is_array||type.is_composite&&type.has_array_field)&&(this.has_array_field=!0),(type.is_sampler||type.is_composite&&type.has_sampler_field)&&(this.has_sampler_field=!0),this.fields.push(field),this.field_map[name]=field,this.zero[name]=type.zero,field},UserType.prototype=glsl.ast.Node.create("builtins.UserType",UserType,CompositeType),exports.UserType=UserType,ArrayType.prototype=glsl.ast.Node.create("builtins.ArrayType",ArrayType,TypeClass),exports.ArrayType=ArrayType,PrimitiveType.prototype=glsl.ast.Node.create("builtins.PrimitiveType",PrimitiveType,TypeClass),exports.PrimitiveType=PrimitiveType,PrimitiveType.prototype.marshal_can_ref=function(){return!1},PrimitiveType.prototype.marshal=function(){return"$"+this.name},PrimitiveType._is_vec=function(tok){switch(tok){case Tn.T_VEC2:case Tn.T_VEC3:case Tn.T_VEC4:case Tn.T_BVEC2:case Tn.T_BVEC3:case Tn.T_BVEC4:case Tn.T_IVEC2:case Tn.T_IVEC3:case Tn.T_IVEC4:return!0}return!1},PrimitiveType._is_sampler=function(tok){switch(tok){case Tn.T_SAMPLER2D:case Tn.T_SAMPLERCUBE:return!0}return!1},PrimitiveType._is_mat=function(tok){switch(tok){case Tn.T_MAT2:case Tn.T_MAT3:case Tn.T_MAT4:return!0}return!1},PrimitiveType._is_scalar=function(tok){switch(tok){case Tn.T_FLOAT:case Tn.T_INT:case Tn.T_BOOL:return!0}return!1},PrimitiveType._element_type=function(tok){switch(tok){case Tn.T_FLOAT:case Tn.T_VEC2:case Tn.T_VEC3:case Tn.T_VEC4:case Tn.T_MAT2:case Tn.T_MAT3:case Tn.T_MAT4:return Tn.T_FLOAT;case Tn.T_INT:case Tn.T_IVEC2:case Tn.T_IVEC3:case Tn.T_IVEC4:return Tn.T_INT;case Tn.T_BOOL:case Tn.T_BVEC2:case Tn.T_BVEC3:case Tn.T_BVEC4:return Tn.T_BOOL}return null},PrimitiveType._length=function(tok){switch(tok){case Tn.T_FLOAT:case Tn.T_INT:case Tn.T_BOOL:return 1;case Tn.T_VEC2:case Tn.T_IVEC2:case Tn.T_BVEC2:case Tn.T_MAT2:return 2;case Tn.T_VEC3:case Tn.T_IVEC3:case Tn.T_BVEC3:case Tn.T_MAT3:return 3;case Tn.T_VEC4:case Tn.T_IVEC4:case Tn.T_BVEC4:case Tn.T_MAT4:return 4}return 0},Operator.prototype._evaluate_elem=function(a,b){switch(this.op){case Tn.T_PLUS:return a+b;case Tn.T_DASH:return a-b;case Tn.T_STAR:return a*b;case Tn.T_SLASH:return a/b;case Tn.T_LEFT_ANGLE:return b>a;case Tn.T_RIGHT_ANGLE:return a>b;case Tn.T_LE_OP:return b>=a;case Tn.T_GE_OP:return a>=b;case Tn.T_EQ_OP:return a==b;case Tn.T_NE_OP:return a!=b;case Tn.T_AND_OP:return a&&b;case Tn.T_OR_OP:return a||b;case Tn.T_XOR_OP:return a&&!b||b&&!a}},Operator.prototype.evaluate=function(a,b){if(this.op==Tn.T_STAR){if(this.lhs.is_vec&&this.rhs.is_mat){for(var ret=[],i=0;i<this.lhs.length;i++){for(var s=0,j=0;j<this.lhs.length;j++)s+=a[j]*b[i][j];ret.push(s)}return ret}if(this.lhs.is_mat&&this.rhs.is_vec){for(var ret=[],i=0;i<this.lhs.length;i++){for(var s=0,j=0;j<this.lhs.length;j++)s+=a[j][i]*b[j];ret.push(s)}return ret}}if(this.lhs.is_vec||this.rhs.is_vec){for(var ret=[],l=this.lhs.is_vec?this.lhs.length:this.rhs.length,i=0;l>i;i++)ret.push(this._evaluate_elem(this.lhs.is_vec?a[i]:a,this.rhs.is_vec?b[i]:b));return ret}if(this.lhs.is_mat||this.rhs.is_mat){for(var ret=[],l=this.lhs.is_mat?this.lhs.length:this.rhs.length,i=0;l>i;i++)for(var j=0;l>j;j++)ret.push(this._evaluate_elem(this.lhs.is_mat?a[i][j]:a,this.rhs.is_mat?b[i][j]:b));return ret}return this._evaluate_elem(a,b)},UnaryOperator.prototype.evaluate=function(a){switch(this.op){case Tn.T_BANG:return!a;case Tn.T_DASH:return-a;case Tn.T_INC_OP:return a+1;case Tn.T_DEC_OP:return a-1}},exports.Builtins=Builtins,Builtins.create_for_context=function(ctx,type){return new Builtins(type,Builtins.options_from_context(ctx))},Builtins.options_from_context=function(ctx){var constants={},c={gl_MaxVertexAttribs:"MAX_VERTEX_ATTRIBS",gl_MaxVertexUniformVectors:"MAX_VERTEX_UNIFORM_VECTORS",gl_MaxVaryingVectors:"MAX_VARYING_VECTORS",gl_MaxVertexTextureImageUnits:"MAX_VERTEX_TEXTURE_IMAGE_UNITS",gl_MaxCombinedTextureImageUnits:"MAX_COMBINED_TEXTURE_IMAGE_UNITS",gl_MaxTextureImageUnits:"MAX_TEXTURE_IMAGE_UNITS",gl_MaxFragmentUniformVectors:"MAX_FRAGMENT_UNIFORM_VECTORS",gl_MaxDrawBuffers:"MAX_DRAW_BUFFERS"};for(var name in c)"undefined"!=typeof ctx[c[name]]&&(contstants[name]=ctx.getParameter(ctx[c[name]]));return{constants:constants}},Builtins.prototype._define_types=function(){for(var btypetoks=[[Tn.T_VOID,0],[Tn.T_FLOAT,0],[Tn.T_INT,0],[Tn.T_BOOL,!1],[Tn.T_VEC2,[0,0]],[Tn.T_VEC3,[0,0,0]],[Tn.T_VEC4,[0,0,0,0]],[Tn.T_BVEC2,[!1,!1]],[Tn.T_BVEC3,[!1,!1,!1]],[Tn.T_BVEC4,[!1,!1,!1,!1]],[Tn.T_IVEC2,[0,0]],[Tn.T_IVEC3,[0,0,0]],[Tn.T_IVEC4,[0,0,0,0]],[Tn.T_MAT2,[[0,0],[0,0]]],[Tn.T_MAT3,[[0,0,0],[0,0,0],[0,0,0]]],[Tn.T_MAT4,[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]],[Tn.T_SAMPLER2D,0],[Tn.T_SAMPLERCUBE,0]],i=0;i<btypetoks.length;i++){var tokid=btypetoks[i][0],zero=btypetoks[i][1],name=dtn.token_name(tokid),bloc=new glsl.source.BuiltinRange,tok=dtn.create_token(tokid,name,bloc),decl=new glsl.ast.TypeDecl(new glsl.ast.TypeRef(tok).complete());decl.semi=dtn.create_token(Tn.T_SEMICOLON,";",bloc),decl.incomplete=!1,decl.type.t={type:new PrimitiveType(tokid,zero)},this.types.push(decl),this.type_map[tokid]=decl,name=name[0].toUpperCase()+name.slice(1),this[name]=decl.type.t.type}},Builtins.prototype._declare_variable=function(qualifiers,typeid,name,arsize,defintval){var type=this.type_map[typeid],bloc=new glsl.source.BuiltinRange,tp=new glsl.ast.TypeRef(dtn.create_token(typeid,dtn.token_name(typeid),bloc));tp.complete();for(var i=0;i<qualifiers.length;i++){var q=qualifiers[i];tp.qualifiers.push(dtn.create_token(q,dtn.token_name(q),bloc))}tp.t={type:type.type.t.type};var decl=new glsl.ast.VariableDecl(tp),n=new glsl.ast.Named(dtn.create_token(Tn.T_IDENTIFIER,name,bloc),decl);n.type=tp,n.t={type:n.type.t.type};var Int=this.type_map[Tn.T_INT].type.t.type;if("undefined"!=typeof arsize&&null!==arsize)if(n.is_array=!0,n.left_bracket=dtn.create_token(Tn.T_LEFT_BRACKET,dtn.token_name(Tn.T_LEFT_BRACKET),bloc),n.right_bracket=dtn.create_token(Tn.T_RIGHT_BRACKET,dtn.token_name(Tn.T_RIGHT_BRACKET),bloc),"string"==typeof arsize){var expr=new glsl.ast.VariableExpr(dtn.create_token(Tn.T_IDENTIFIER,arsize,bloc));expr.complete();var c=this.variable_map[arsize];expr.t={decl:c,type:c.names[0].t.type,is_const_expression:!0,const_value:c.names[0].t.const_value},n.array_size=expr}else{var tok=dtn.create_token(Tn.T_INTCONSTANT,""+arsize,bloc);tok.value=arsize,n.array_size=new glsl.ast.ConstantExpr(tok),n.array_size.complete(),n.array_size.t={type:Int,is_const_expression:!0,const_value:arsize}}if("undefined"!=typeof defintval&&null!==defintval){"undefined"!=typeof this._options.constants&&name in this._options.constants&&(defintval=this._options.constants[name]),n.initial_assign=dtn.create_token(Tn.T_EQUAL,dtn.token_name(Tn.T_EQUAL),bloc);var tok=dtn.create_token(Tn.T_INTCONSTANT,""+defintval,bloc);tok.value=defintval,n.initial_value=new glsl.ast.ConstantExpr(tok),n.initial_value.complete(),n.initial_value.t={type:Int,is_const_expression:!0,const_value:defintval},n.t.is_const_expression=!0,n.t.const_value=defintval}n.complete(),decl.names.push(n),decl.complete(),decl.t={type:tp.t.type},this.variables.push(decl),this.variable_map[name]=decl},Builtins.prototype._define_constants=function(){this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxVertexAttribs",null,8),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxVertexUniformVectors",null,128),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxVaryingVectors",null,8),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxVertexTextureImageUnits",null,0),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxCombinedTextureImageUnits",null,8),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxTextureImageUnits",null,8),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxFragmentUniformVectors",null,16),this._declare_variable([Tn.T_CONST,Tn.T_MEDIUMP],Tn.T_INT,"gl_MaxDrawBuffers",null,1)},Builtins.prototype._define_variables=function(){switch(this.type){case glsl.source.VERTEX:this._declare_variable([Tn.T_HIGHP],Tn.T_VEC4,"gl_Position"),this._declare_variable([Tn.T_MEDIUMP],Tn.T_FLOAT,"gl_PointSize");break;case glsl.source.FRAGMENT:this._declare_variable([Tn.T_MEDIUMP],Tn.T_VEC4,"gl_FragCoord"),this._declare_variable([],Tn.T_BOOL,"gl_FrontFacing"),this._declare_variable([Tn.T_MEDIUMP],Tn.T_VEC4,"gl_FragColor"),this._declare_variable([Tn.T_MEDIUMP],Tn.T_VEC4,"gl_FragData","gl_MaxDrawBuffers"),this._declare_variable([Tn.T_MEDIUMP],Tn.T_VEC2,"gl_PointCoord")}},Builtins.prototype._elem_evaluator=function(){for(var l=0,i=0;i<arguments.length;i++)if(Array.prototype.isPrototypeOf(arguments[i])){l=arguments[i].length;break}if(0===l)return this.apply(this,arguments);for(var ret=[],i=0;l>i;i++){for(var args=[],j=0;j<arguments.length;j++){var arg=arguments[j];args.push(Array.prototype.isPrototypeOf(arg)?arg[i]:arg)}ret.push(this.apply(this,args))}return ret},Builtins.prototype._func_evaluator=function(){for(var args=[],i=0;i<arguments.length;i++)args.push(Array.prototype.isPrototypeOf(arguments[i])?arguments[i]:[arguments[i]]);return this.apply(this,args)},Builtins.prototype._define_builtin_function=function(rettype,name,params,elemfunc,func){glsl.ast.TypeDecl.prototype.isPrototypeOf(rettype)||(rettype=this.type_map[rettype]);for(var sp=params.slice(),i=0;i<sp.length;i+=2){var p=sp[i];glsl.ast.TypeDecl.prototype.isPrototypeOf(p)||(sp[i]=this.type_map[p])}var bloc=new glsl.source.BuiltinRange,type=new glsl.ast.TypeRef(dtn.create_token(rettype.type.token.id,dtn.token_name(rettype.type.token.id),bloc));type.incomplete=!1,type.t={type:rettype.type.t.type};var name=dtn.create_token(Tn.T_IDENTIFIER,name,bloc),header=new glsl.ast.FunctionHeader(type,name);header.left_paren=dtn.create_token(Tn.T_LEFT_PAREN,"(",bloc),header.right_paren=dtn.create_token(Tn.T_RIGHT_PAREN,")",bloc),header.incomplete=!1;for(var i=0;i<sp.length;i+=2){var p=sp[i],decl=(new glsl.ast.ParamDecl).complete();decl.type=p.type,decl.name=dtn.create_token(Tn.T_IDENTIFIER,sp[i+1],bloc),header.parameters.push(decl)}var sig=header.signature();if(!(sig in this.function_map)){var f=new glsl.ast.FunctionProto(header);return f.is_builtin=!0,f.semi=dtn.create_token(Tn.T_SEMICOLON,";",bloc),f.incomplete=!1,f.evaluate=elemfunc?this._elem_evaluator.bind(elemfunc):func?this._func_evaluator.bind(func):null,this.functions.push(f),this.function_map[sig]=f,f}},Builtins.prototype._define_builtin_function_gen=function(gentypes,rettype,name,params,elemfunc,func){null!==rettype&&(rettype=this.type_map[rettype]);for(var i=0;i<gentypes.length;i++){for(var g=this.type_map[gentypes[i]],sp=params.slice(),j=0;j<sp.length;j+=2){var item=sp[j];sp[j]=null===item?g:this.type_map[item]}this._define_builtin_function(null!==rettype?rettype:g,name,sp,elemfunc,func)}},Builtins.prototype._define_builtin_gentype_function=function(rettype,name,params,elemfunc,func){var gentypes=[Tn.T_FLOAT,Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4];this._define_builtin_function_gen(gentypes,rettype,name,params,elemfunc,func)},Builtins.prototype._define_builtin_mat_function=function(rettype,name,params,elemfunc,func){var gentypes=[Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT4];this._define_builtin_function_gen(gentypes,rettype,name,params,elemfunc,func)},Builtins.prototype._define_builtin_relvec_function=function(rettype,name,params,elemfunc,func){for(var vmap={bvec:[Tn.T_BVEC2,Tn.T_BVEC3,Tn.T_BVEC4],vec:[Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4],ivec:[Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]},i=0;3>i;i++){var ret=rettype;rettype in vmap&&(ret=vmap[rettype][i]);for(var sp=params.slice(),j=0;j<sp.length;j+=2){var p=sp[j];p in vmap&&(sp[j]=vmap[p][i])}this._define_builtin_function(ret,name,sp,elemfunc,func)}},Builtins.prototype._find_type=function(t,def){return null===t&&(t=def),this.type_map[t].type.t.type},Builtins.prototype._define_builtin_bin_operator_gen=function(rettype,optypes,lhs,rhs,gens){for(var i=0;i<optypes.length;i++)for(var op=optypes[i],j=0;j<gens.length;j++){var g=gens[j],o=new Operator(op);o.ret=this._find_type(rettype,g),o.lhs=this._find_type(lhs,g),o.rhs=this._find_type(rhs,g);var sig=dtn.token_name(op)+"("+o.lhs.name+","+o.rhs.name+")";this.operators.push(o),this.operator_map[sig]=o}},Builtins.prototype._define_builtin_unary_operator_gen=function(rettype,optypes,expr,gens){for(var i=0;i<optypes.length;i++)for(var op=optypes[i],j=0;j<gens.length;j++){var g=gens[j],o=new UnaryOperator(op);
o.ret=this._find_type(rettype,g),o.expr=this._find_type(expr,g);var sig=dtn.token_name(op)+"("+o.expr.name+")";this.operators.push(o),this.operator_map[sig]=o}};var Emulate={radians:function(degrees){return degrees/180*Math.PI},degrees:function(radians){return radians/Math.PI*180},exp2:function(x){return Math.pow(2,x)},log2:function(x){return Math.log(x)/Math.log(2)},inversesqrt:function(x){return 1/Math.sqrt(x)},sign:function(x){return 0>x?-1:x>0?1:0},fract:function(x){return x-Math.floor(x)},mod:function(x,y){return x-y*Math.floor(x/y)},clamp:function(x,minVal,maxVal){return Math.min(Math.max(x,minVal),maxVal)},mix:function(x,y,a){return x*(1-a)+y*a},smoothstep:function(edge0,edge1,x){if(edge0>x)return 0;if(x>edge1)return 1;var n=(x-edge0)/(edge1-edge0);return n*n*(3-2*n)},step:function(edge,x){return edge>x?0:1},length:function(x){for(var s=0,i=0;i<x.length;i++)s+=x[i]*x[i];return Math.sqrt(s)},distance:function(p0,p1){for(var s=0,i=0;i<p0.length;i++){var d=p0[i]-p1[i];s+=d*d}return Math.sqrt(s)},dot:function(x,y){for(var s=0,i=0;i<x.length;i++)s+=x[i]*y[i];return s},cross:function(x,y){return[x[1]*y[2]-y[1]*x[2],x[2]*y[0]-y[2]*x[0],x[0]*y[1]-y[0]*x[1]]},normalize:function(x){for(var s=[],l=Emulate.length(x),i=0;i<x.length;i++)s.push(x[i]/l);return s},faceforward:function(N,I,Nref){for(var s=[],isit=Emulate.dot(Nref,I),i=0;i<N.length;i++)s.push(isit?N[i]:-N[i]);return s},reflect:function(I,N){for(var d=Emulate.dot(N,I),s=[],i=0;i<I.length;i++)s.push(I[i]-2*d*N[i]);return s},refract:function(I,N,eta){eta=eta[0];var d=Emulate.dot(N,I),k=1-eta*eta*(1-d*d),s=[],sk=0;k>=0&&(sk=eta*d+Math.sqrt(k));for(var i=0;i<I.length;i++)s.push(0>k?0:eta*I[i]-sk*N[i]);return s},matrixCompMult:function(x,y){return x*y},lessThan:function(x,y){return y>x},lessThanEqual:function(x,y){return y>=x},greaterThan:function(x,y){return x>y},greaterThanEqual:function(x,y){return y>x},equal:function(x,y){return x==y},notEqual:function(x,y){return x!=y},any:function(x){for(var i=0;i<x.length;i++)if(x[i])return!0;return!1},all:function(x){for(var i=0;i<x.length;i++)if(!x[i])return!1;return!0},not:function(x){return!x}};Builtins.prototype._define_functions=function(){this._define_builtin_function(Tn.T_VOID,"main",[]),this._define_builtin_gentype_function(null,"radians",[null,"degrees"],Emulate.radians),this._define_builtin_gentype_function(null,"degrees",[null,"radians"],Emulate.degrees),this._define_builtin_gentype_function(null,"sin",[null,"angle"],Math.sin),this._define_builtin_gentype_function(null,"cos",[null,"angle"],Math.cos),this._define_builtin_gentype_function(null,"tan",[null,"angle"],Math.tan),this._define_builtin_gentype_function(null,"asin",[null,"x"],Math.asin),this._define_builtin_gentype_function(null,"acos",[null,"x"],Math.acos),this._define_builtin_gentype_function(null,"atan",[null,"y",null,"x"],Math.atan2),this._define_builtin_gentype_function(null,"atan",[null,"y_over_x"],Math.atan),this._define_builtin_gentype_function(null,"pow",[null,"x",null,"y"],Math.pow),this._define_builtin_gentype_function(null,"exp",[null,"x"],Math.exp),this._define_builtin_gentype_function(null,"log",[null,"x"],Math.log),this._define_builtin_gentype_function(null,"exp2",[null,"x"],Emulate.exp2),this._define_builtin_gentype_function(null,"log2",[null,"x"],Emulate.log2),this._define_builtin_gentype_function(null,"sqrt",[null,"x"],Math.sqrt),this._define_builtin_gentype_function(null,"inversesqrt",[null,"x"],Emulate.inversesqrt),this._define_builtin_gentype_function(null,"abs",[null,"x"],Math.abs),this._define_builtin_gentype_function(null,"sign",[null,"x"],Emulate.sign),this._define_builtin_gentype_function(null,"floor",[null,"x"],Math.floor),this._define_builtin_gentype_function(null,"ceil",[null,"x"],Math.ceil),this._define_builtin_gentype_function(null,"fract",[null,"x"],Emulate.fract),this._define_builtin_gentype_function(null,"mod",[null,"x",null,"y"],Emulate.mod),this._define_builtin_gentype_function(null,"min",[null,"x",null,"y"],Math.min),this._define_builtin_gentype_function(null,"min",[null,"x",Tn.T_FLOAT,"y"],Math.min),this._define_builtin_gentype_function(null,"max",[null,"x",null,"y"],Math.max),this._define_builtin_gentype_function(null,"max",[null,"x",Tn.T_FLOAT,"y"],Math.max),this._define_builtin_gentype_function(null,"clamp",[null,"x",null,"minVal",null,"maxVal"],Emulate.clamp),this._define_builtin_gentype_function(null,"clamp",[null,"x",Tn.T_FLOAT,"minVal",Tn.T_FLOAT,"maxVal"],Emulate.clamp),this._define_builtin_gentype_function(null,"mix",[null,"x",null,"y",null,"a"],Emulate.mix),this._define_builtin_gentype_function(null,"mix",[null,"x",null,"y",Tn.T_FLOAT,"a"],Emulate.mix),this._define_builtin_gentype_function(null,"step",[null,"edge",null,"x"],Emulate.step),this._define_builtin_gentype_function(null,"step",[Tn.T_FLOAT,"edge",null,"x"],Emulate.step),this._define_builtin_gentype_function(null,"smoothstep",[null,"edge0",null,"edge1",null,"x"],Emulate.smoothstep),this._define_builtin_gentype_function(null,"smoothstep",[Tn.T_FLOAT,"edge0",Tn.T_FLOAT,"edge1",null,"x"],Emulate.smootstep),this._define_builtin_gentype_function(Tn.T_FLOAT,"length",[null,"x"],null,Emulate.length),this._define_builtin_gentype_function(Tn.T_FLOAT,"distance",[null,"p0",null,"p1"],null,Emulate.distance),this._define_builtin_gentype_function(Tn.T_FLOAT,"dot",[null,"x",null,"y"],null,Emulate.dot),this._define_builtin_function(Tn.T_VEC3,"cross",[Tn.T_VEC3,"x",Tn.T_VEC3,"y"],null,Emulate.cross),this._define_builtin_gentype_function(null,"normalize",[null,"x"],null,Emulate.normalize),this._define_builtin_gentype_function(null,"faceforward",[null,"N",null,"I",null,"Nref"],null,Emulate.faceforward),this._define_builtin_gentype_function(null,"reflect",[null,"I",null,"N"],null,Emulate.reflect),this._define_builtin_gentype_function(null,"refract",[null,"I",null,"N",Tn.T_FLOAT,"eta"],null,Emulate.refract),this._define_builtin_mat_function(null,"matrixCompMult",[null,"x",null,"y"],Emulate.matrixCompMult),this._define_builtin_relvec_function("bvec","lessThan",["vec","x","vec","y"],Emulate.lessThan),this._define_builtin_relvec_function("bvec","lessThan",["ivec","x","ivec","y"],Emulate.lessThan),this._define_builtin_relvec_function("bvec","lessThanEqual",["vec","x","vec","y"],Emulate.lessThanEqual),this._define_builtin_relvec_function("bvec","lessThanEqual",["ivec","x","ivec","y"],Emulate.lessThanEqual),this._define_builtin_relvec_function("bvec","greaterThan",["vec","x","vec","y"],Emulate.greaterThan),this._define_builtin_relvec_function("bvec","greaterThan",["ivec","x","ivec","y"],Emulate.greaterThan),this._define_builtin_relvec_function("bvec","greaterThanEqual",["vec","x","vec","y"],Emulate.greaterThanEqual),this._define_builtin_relvec_function("bvec","greaterThanEqual",["ivec","x","ivec","y"],Emulate.greaterThanEqual),this._define_builtin_relvec_function("bvec","equal",["vec","x","vec","y"],Emulate.equal),this._define_builtin_relvec_function("bvec","equal",["ivec","x","ivec","y"],Emulate.equal),this._define_builtin_relvec_function("bvec","notEqual",["vec","x","vec","y"],Emulate.notEqual),this._define_builtin_relvec_function("bvec","notEqual",["ivec","x","ivec","y"],Emulate.notEqual),this._define_builtin_relvec_function("bvec","notEqual",["bvec","x","bvec","y"],Emulate.notEqual),this._define_builtin_relvec_function(Tn.T_BOOL,"any",["bvec","x"],null,Emulate.any),this._define_builtin_relvec_function(Tn.T_BOOL,"all",["bvec","x"],null,Emulate.all),this._define_builtin_relvec_function("bvec","not",["bvec","x"],Emulate.not),this._define_builtin_function(Tn.T_VEC4,"texture2D",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC2,"coord"]),this._define_builtin_function(Tn.T_VEC4,"texture2D",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC2,"coord",Tn.T_FLOAT,"bias"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProj",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC3,"coord"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProj",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC3,"coord",Tn.T_FLOAT,"bias"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProj",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC4,"coord"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProj",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC4,"coord",Tn.T_FLOAT,"bias"]),this.type==glsl.source.VERTEX&&(this._define_builtin_function(Tn.T_VEC4,"texture2DLod",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC2,"coord",Tn.T_FLOAT,"lod"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProjLod",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC3,"coord",Tn.T_FLOAT,"lod"]),this._define_builtin_function(Tn.T_VEC4,"texture2DProjLod",[Tn.T_SAMPLER2D,"sampler",Tn.T_VEC4,"coord",Tn.T_FLOAT,"lod"])),this._define_builtin_function(Tn.T_VEC4,"textureCube",[Tn.T_SAMPLERCUBE,"sampler",Tn.T_VEC3,"coord"]),this._define_builtin_function(Tn.T_VEC4,"textureCube",[Tn.T_SAMPLERCUBE,"sampler",Tn.T_VEC3,"coord",Tn.T_FLOAT,"bias"]),this.type==glsl.source.VERTEX&&this._define_builtin_function(Tn.T_VEC4,"textureCubeLod",[Tn.T_SAMPLERCUBE,"sampler",Tn.T_VEC3,"coord",Tn.T_FLOAT,"lod"])},Builtins.prototype._define_operators=function(){this._define_builtin_bin_operator_gen(null,[Tn.T_PLUS,Tn.T_DASH,Tn.T_STAR,Tn.T_SLASH],null,null,[Tn.T_INT,Tn.T_FLOAT,Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4,Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT4,Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]),this._define_builtin_bin_operator_gen(null,[Tn.T_PLUS,Tn.T_DASH,Tn.T_STAR,Tn.T_SLASH],Tn.T_FLOAT,null,[Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4,Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT3]),this._define_builtin_bin_operator_gen(null,[Tn.T_PLUS,Tn.T_DASH,Tn.T_STAR,Tn.T_SLASH],null,Tn.T_FLOAT,[Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4,Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT3]),this._define_builtin_bin_operator_gen(null,[Tn.T_PLUS,Tn.T_DASH,Tn.T_STAR,Tn.T_SLASH],Tn.T_INT,null,[Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]),this._define_builtin_bin_operator_gen(null,[Tn.T_PLUS,Tn.T_DASH,Tn.T_STAR,Tn.T_SLASH],null,Tn.T_INT,[Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_MAT2,null,[Tn.T_VEC2]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_MAT3,null,[Tn.T_VEC3]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_MAT4,null,[Tn.T_VEC4]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_VEC2,null,[Tn.T_MAT2]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_VEC3,null,[Tn.T_MAT3]),this._define_builtin_bin_operator_gen(null,[Tn.T_STAR],Tn.T_VEC4,null,[Tn.T_MAT4]),this._define_builtin_bin_operator_gen(Tn.T_BOOL,[Tn.T_LEFT_ANGLE,Tn.T_RIGHT_ANGLE,Tn.T_LE_OP,Tn.T_GE_OP],null,null,[Tn.T_FLOAT,Tn.T_INT]),this._define_builtin_bin_operator_gen(Tn.T_BOOL,[Tn.T_EQ_OP,Tn.T_NE_OP],null,null,[Tn.T_INT,Tn.T_FLOAT,Tn.T_BOOL,Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4,Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT4,Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]),this._define_builtin_bin_operator_gen(null,[Tn.T_AND_OP,Tn.T_OR_OP,Tn.T_XOR_OP],null,null,[Tn.T_BOOL]),this._define_builtin_unary_operator_gen(null,[Tn.T_DASH,Tn.T_DEC_OP,Tn.T_INC_OP],null,[Tn.T_INT,Tn.T_FLOAT,Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4,Tn.T_MAT2,Tn.T_MAT3,Tn.T_MAT4,Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]),this._define_builtin_unary_operator_gen(null,[Tn.T_BANG],null,[Tn.T_BOOL])}}(ns);var ns;if("undefined"!=typeof window||"undefined"!=typeof self){var ctx="undefined"!=typeof window?window:self;"undefined"==typeof ctx.glsl&&(ctx.glsl={}),ctx.glsl.sst={},ns=ctx.glsl.sst,global=ctx}else{var glsl={source:require("./source"),ast:require("./ast"),tokenizer:require("./tokenizer"),builtins:require("./builtins")};ns=exports}!function(exports){"use strict";function Error(loc,message){glsl.source.Error.call(this,loc,message)}function Annotate(ast,opts){new Annotator(ast,opts).annotate()}function Annotator(ast,opts){this._ast=ast,"undefined"==typeof opts&&(opts={}),this._builtins="undefined"!=typeof opts.builtins?opts.builtins:new glsl.builtins.Builtins(ast.type),this._ast.function_protos=[],this._ast.function_proto_map={},this._ast.functions=[],this._ast.function_map={},this._scope=null,this._scopes=[];var bscope=this._push_scope({function_protos:[],function_proto_map:{}});bscope.marshal=function(){return"(builtin scope)"};for(var i=0;i<this._builtins.types.length;i++){var btype=this._builtins.types[i],t=btype.type.t.type;this._declare_type(t)}for(var i=0;i<this._builtins.functions.length;i++){var f=this._builtins.functions[i];this._scope.function_proto_map[f.header.signature()]=f,this._scope.function_protos.push(f)}for(var i=0;i<this._builtins.variables.length;i++){var v=this._builtins.variables[i];this._declare_variable(v.names[0])}this._push_scope(ast),this._errors=[]}var Tn=glsl.tokenizer.Tokenizer;Error.prototype=Object.create(glsl.source.Error.prototype),Error.prototype.constructor=Error,exports.Error=Error,Annotator.prototype.annotate=function(){this._annotate_node(this._ast),this._ast._errors=this._ast._errors.concat(this._errors)},Annotator.prototype._is_toplevel_scope=function(){return this._scope==this._ast},Annotator.prototype._push_scope=function(node){return glsl.ast.StructDecl.prototype.isPrototypeOf(node)||(node.variables=[],node.variable_map={}),node.types=[],node.type_map={},node.symbols={},node.parent_scope=this._scope,this._scope=node,this._scopes.unshift(this._scope),node},Annotator.prototype._pop_scope=function(){var ret=this._scopes.shift();return this._scope=this._scopes[0],ret},Annotator.prototype._annotate_node=function(node){if(null!==node){var n=node.node_name.replace(/\B[A-Z]+/g,"_$&").toLowerCase(),fn="_annotate_"+n;if("function"!=typeof this[fn])throw new global.Error("no annotator available for "+node.node_name);return node.t={type:null},this[fn](node)}},Annotator.prototype._annotate_parser=function(node){for(var i=0;i<node.body.length;i++)this._annotate_node(node.body[i])},Annotator.prototype._lookup=function(name,mapname){for(var scope=this._scope;null!==scope;){if("undefined"!=typeof scope[mapname]&&name in scope[mapname])return scope[mapname][name];scope=scope.parent_scope}return null},Annotator.prototype._lookup_type=function(name){return this._lookup(name,"type_map")},Annotator.prototype._lookup_symbol=function(name){return this._lookup(name,"symbols")},Annotator.prototype._lookup_function=function(name){return this._lookup(name,"function_map")},Annotator.prototype._lookup_function_proto=function(name){return this._lookup(name,"function_proto_map")},Annotator.prototype._lookup_function_or_proto=function(name){var f=this._lookup_function(name);return null!==f?f:this._lookup_function_proto(name)},Annotator.prototype._declare_type=function(type){this._scope.types.push(type),this._scope.type_map[type.name]=type,this._scope.symbols[type.name]=type},Annotator.prototype._declare_variable=function(node){this._scope.variable_map[node.name.text]=node,this._scope.variables.push(node),this._scope.symbols[node.name.text]=node},Annotator.prototype._lookup_or_declare_type=function(type){var tp=this._lookup_type(type.name);return null===tp?(this._declare_type(type),type):tp},Annotator.prototype._annotate_type_ref=function(type){type.incomplete||(null!==type.decl?(this._annotate_node(type.decl),type.t.type=type.decl.t.type):type.t.type=type.is_primitive?this._builtins.type_map[type.token.id].type.t.type:this._lookup_type(type.token.text),null===type.t.type&&this._error(type.location(),"unknown type "+type.token.text))},Annotator.prototype._annotate_array=function(node,element_type){node.is_array&&this._resolve_array_size(node)&&(node.t.type=this._lookup_or_declare_type(new glsl.builtins.ArrayType(element_type,node.array_size.t.const_value)))},Annotator.prototype._annotate_named=function(node){this._annotate_node(node.initial_value),node.is_array?this._annotate_array(node,node.type.t.type):node.t.type=node.type.t.type,null!==node.t.type&&(node.type.is_attribute()&&(node.t.type.is_composite?this._error(node.location(),"structures cannot be attributes"):node.t.type.is_array&&this._error(node.location(),"arrays cannot be attributes")),node.type.is_varying()&&node.t.type.is_composite&&this._error(node.location(),"structures cannot be varying")),node.type.is_attribute()&&(this._ast.type!=glsl.source.VERTEX&&this._error(node.location(),"attributes can only be declared in vertex shaders"),this._is_toplevel_scope()||this._error(node.location(),"attributes can only be declared globally"),null!==node.initial_value&&this._error(node.initial_value.location(),"attributes cannot have an initial value")),node.type.is_uniform()&&(this._is_toplevel_scope()||this._error(node.location(),"uniforms can only be declared globally"),null!==node.initial_value&&this._error(node.initial_value.location(),"uniforms cannot have an initial value")),node.type.is_varying()&&(this._is_toplevel_scope()||this._error(node.location(),"varyings can only be declared globally"),null!==node.initial_value&&this._error(node.initial_value.location(),"varyings cannot have an initial value")),node.type.is_const()&&(node.is_array?this._error(node.location(),"arrays cannot be declared as const"):node.t.type.is_composite&&node.t.type.has_array_field&&this._error(node.location(),"cannot declare a struct containing an array as const"),null!==node.initial_value?node.initial_value.t.is_const_expression?(node.t.is_const_expression=!0,node.t.const_value=node.initial_value.t.const_value):this._error(node.initial_value.location(),"expected constant initial value expression"):(this._error(node.location(),"missing constant value initialization"),node.t.is_const_expression=!0,node.t.const_value=node.t.type.zero))},Annotator.prototype._annotate_param_decl=function(node){this._annotate_node(node.type),node.is_array?this._annotate_array(node,node.type.t.type):node.t.type=node.type.t.type},Annotator.prototype._annotate_variable_decl=function(node){this._annotate_node(node.type);for(var i=0;i<node.names.length;i++){var name=node.names[i];if(this._annotate_node(name),null!==name.name&&name.name.text in this._scope.symbols){var sym=this._scope.symbols[name.name.text];if(glsl.ast.Named.prototype.isPrototypeOf(sym)&&glsl.ast.VariableDecl.prototype.isPrototypeOf(sym.decl)){this._error(name.location(),"the variable '"+name.name.text+"' has already been declared in this scope, previous declaration was at "+sym.location().inspect());continue}this._error(name.location(),"a "+this._error_symbol_type_name(sym)+" '"+name.name.text+"' has already been declared in this scope, previous declaration was at "+sym.location().inspect())}this._declare_variable(name)}},Annotator.prototype._annotate_type_decl=function(node){this._annotate_node(node.type)},Annotator.prototype._annotate_struct_decl=function(node){var type;if(glsl.ast.StructDecl.prototype.isPrototypeOf(this._scope)&&this._error(node.location(),"nested struct declarations are not allowed"),null!==node.name){var tp=this._lookup_symbol(node.name.text);if(null!==tp)return void this._error(node.location(),"a type named "+node.name.text+" has already been declared, previous declaration was at "+tp.location().inspect());type=new glsl.builtins.UserType(node.name.text,node),this._declare_type(type)}else type=new glsl.builtins.UserType(null,node);node.t.type=type,this._push_scope(node);for(var field_map={},i=0;i<node.fields.length;i++){var field=node.fields[i];this._annotate_node(field.type);for(var j=0;j<field.names.length;j++){var name=field.names[j];this._annotate_node(name);var f=node.t.type.declare_field(name.name.text,name.type.t.type);f.decl=name,name.name.text in field_map&&this._error(name.location(),"a field named "+name.name.text+" already exists, previous declaration was at "+field_map[name.name.text].location().inspect()),field_map[name]=field}}this._pop_scope(node)},Annotator.prototype._resolve_array_size=function(node){if(!node.is_array)return!1;if(this._annotate_node(node.array_size),!node.array_size.t.is_const_expression)return this._error(node.array_size.location(),"expected constant expression for array size"),!1;if(node.array_size.t.type!=this._builtins.Int){var n;return n=node.array_size.t.type==this._builtins.Float?"float":node.array_size.t.type==this._builtins.Bool?"boolean":"user type",this._error(node.array_size.location(),"expected constant integer expression for array size, but got "+n),!1}return node.array_size.const_value<=0&&this._error(node.array_size.location(),"array size must be larger or equal to 1, but got "+node.array_size_.const_value),!0},Annotator.prototype._annotate_function_header=function(node){this._annotate_node(node.type),null!==node.type.t.type&&node.type.t.type.is_array&&this._error(node.type.location(),"array return values are not allowed"),node.t.type=node.type.t.type;for(var i=0;i<node.parameters.length;i++)this._annotate_node(node.parameters[i])},Annotator.prototype._annotate_function_proto=function(node){if(!this._is_toplevel_scope())return void this._error(node.location(),"nested function prototypes are not allowed");var id=node.header.signature(),name=node.header.name,prev=this._lookup_function(id);if(null!==prev)return void this._error(name.location,"the function prototype "+name.text+" appears after its definition at "+prev.name.location);if(name.text in this._scope.symbols){var sym=this._scope.symbols[name.text];return void this._error(name.location,"a "+this._error_symbol_type_name(sym)+" "+name.text+" has already been declared, previous declaration was at "+sym.location())}this._annotate_node(node.header),node.t.type=node.header.t.type,this._scope.function_protos.push(node),this._scope.function_proto_map[id]=node},Annotator.prototype._qualifiers_to_string=function(qualifiers){for(var ret="",i=0;i<qualifiers.length;i++){var q=qualifiers[i];0!==i&&(ret+=" "),ret+=q.token.text}return ret},Annotator.prototype._matching_qualifiers=function(a,b){if(a.length!=b.length)return!1;for(var cpa=a.slice(),cpb=b.slice();cpa.length>0;){var i=cpb.indexOf(cpa.pop());if(-1===i)return!1;cpb.splice(i,1)}return 0!==cpb.length?!1:!0},Annotator.prototype._annotate_function_def=function(node){if(!this._is_toplevel_scope())return void this._error(node.location(),"nested function definitions are not allowed");var id=node.header.signature(),name=node.header.name,prev=this._lookup_function(id);if(null!==prev)return void this._error(name.location,"the function "+name.text+" is already defined, previous definition was at "+prev.name.location.inspect());if(name.text in this._scope.symbols){var sym=this._scope.symbols[name.text];return void this._error(name.location,"a "+this._error_symbol_type_name(sym)+" "+name.text+" has already been declared, previous declaration was at "+sym.location())}this._annotate_node(node.header),node.t.type=node.header.t.type;var proto=this._lookup_function_proto(id);if(null!==proto&&(proto.header.type.type!=node.header.type.type&&this._error(node.header.type.location(),"the return type "+node.header.type.token.text+" of the function definition of "+name.text+" does not correspond to the return type "+proto.header.type.token.text+" of its prototype declared at "+proto.location()),node.header.parameters.length==proto.header.parameters.length))for(var i=0;i<node.header.parameters.length;i++){var param1=node.header.parameters[i],param2=proto.header.parameters[i];this._matching_qualifiers(param1.type.qualifiers,param2.type.qualifiers)||this._error(param1.location(),"the type qualifiers of parameter "+param1.name.text+" ("+this._qualifiers_to_string(param1.type.qualifiers)+") of the function definition of "+name.text+" do not correspond to the parameter type qualifiers "+this._qualifiers_to_string(param2.type.qualifiers)+" of its prototype declared at "+param2.location())}this._scope.functions.push(node),this._scope.function_map[id]=node,this._push_scope(node);for(var i=0;i<node.header.parameters.length;i++){var param=node.header.parameters[i];(0!==i||param.type.token.id!=Tn.T_VOID)&&(this._scope.variables.push(param),this._scope.variable_map[param.name.text]=param,this._scope.symbols[param.name.text]=param)}this._annotate_node(node.body),this._pop_scope()},Annotator.prototype._annotate_block=function(node){node.new_scope&&this._push_scope(node);for(var i=0;i<node.body.length;i++){var item=node.body[i];this._annotate_node(item)}node.new_scope&&this._pop_scope()},Annotator.prototype._annotate_precision_stmt=function(node){if(this._annotate_node(node.type),null!==node.type.t.type){var tp=node.type.t.type,allowed=[this._builtins.Int,this._builtins.Float,this._builtins.Sampler2D,this._builtins.SamplerCube];-1==allowed.indexOf(tp)&&this._error(node.location(),"precision can only be set for int, float and sampler types")}},Annotator.prototype._error_symbol_type_name=function(node){for(var map=[[glsl.ast.FunctionDef,"function definition"],[glsl.ast.FunctionProto,"function prototype"],[glsl.ast.StructDecl,"struct"],[glsl.ast.VariableDecl,"variable"]],i=0;i<map.length;i++){var item=map[i];if(item[0].prototype.isPrototypeOf(node))return item[1]}return node.node_name},Annotator.prototype._annotate_invariant_decl=function(node){for(var i=0;i<node.names.length;i++){var name=node.names[i],symbol=this._lookup_symbol(name.text);if(null===symbol)this._error(name.location,"cannot make unknown variable "+name.text+" invariant");else if(!glsl.ast.Named.prototype.isPrototypeOf(symbol)||!glsl.ast.VariableDecl.prototype.isPrototypeOf(symbol.decl)){var n=this._error_symbol_type_name(symbol);this._error(name.location,"cannot make the "+n+" "+name.text+" invariant")}}},Annotator.prototype._annotate_expression_stmt=function(node){this._annotate_node(node.expression)},Annotator.prototype._init_expr=function(node){node.t.is_const_expression=!1,node.t.const_value=null},Annotator.prototype._annotate_constant_expr=function(node){switch(this._init_expr(node),node.t.is_const_expression=!0,node.t.const_value=node.token.value,node.token.id){case Tn.T_INTCONSTANT:node.t.type=this._builtins.Int;break;case Tn.T_FLOATCONSTANT:node.t.type=this._builtins.Float;break;case Tn.T_BOOLCONSTANT:node.t.type=this._builtins.Bool}},Annotator.prototype._annotate_function_call_expr=function(node){this._init_expr(node);var argnames=[];node.t.decl=null,node.t.is_constructor=!1;for(var isok=!0,i=0;i<node.arguments.length;i++){var arg=node.arguments[i];this._annotate_node(arg),null!==arg.t.type?(0!==i||arg.t.type!=this._builtins.Void)&&argnames.push(arg.t.type.name):isok=!1}if(isok){var tp=this._lookup_type(node.name.text);if(null===tp){var sig=glsl.ast.FunctionHeader.signature_from_names(node.name.text,argnames),f=this._lookup_function_or_proto(sig);if(null===f)return void this._error(node.location(),"could not find function matching signature "+sig);if(glsl.ast.FunctionProto.prototype.isPrototypeOf(f)&&f.is_builtin&&null!==f.evaluate){for(var cargs=[],i=0;i<node.arguments.length;i++){var arg=node.arguments[i];if(!arg.t.is_const_expression){cargs=null;break}cargs.push(arg.t.const_value)}null!==cargs&&(node.t.is_const_expression=!0,node.t.const_value=f.evaluate.apply(this,cargs))}node.t.type=f.header.type.t.type,node.t.decl=f}else if(node.t.type=tp,node.t.is_constructor=!0,tp.is_primitive){if(tp.is_scalar)if(1!=node.arguments.length)this._error(node.location(),"constructor of type "+tp.name+" requires exactly 1 argument, "+node.arguments.length+" given");else{var nt=node.arguments[0].t;nt.type.is_primitive?nt.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=nt.type.is_scalar?nt.const_value:nt.const_value[0]):this._error(node.location,"constructor of type "+tp.name+" cannot be called with type "+nt.type.name)}else if(tp.is_vec||tp.is_mat)if(1==node.arguments.length){var arg0=node.arguments[0].t;if(arg0.type.is_scalar&&arg0.is_const_expression){node.t.is_const_expression=!0,node.t.const_value=[];for(var i=0;i<tp.length;i++)if(tp.is_vec)node.t.const_value.push(arg0.const_value);else{for(var col=[],j=0;j<tp.length;j++)col.push(j==i?arg0.const_value:0);node.t.const_value.push(col)}}else if(!arg0.type.is_scalar)if(arg0.type.is_vec!=tp.is_vec||arg0.type.is_mat!=tp.is_mat)this._error(node.location(),"cannot call constructor of type "+tp.name+" with argument of type "+arg0.type.name);else if(arg0.is_const_expression){node.t.is_const_expression=!0,node.t.const_value=[];for(var i=0;i<tp.length;i++)if(tp.is_vec)node.t.const_value.push(i>=arg0.type.length?0:arg0.const_value[i]);else{for(var col=[],j=0;j<tp.length;j++)col.push(i>=arg0.type.length||j>=arg0.type.length?i==j?1:0:arg0.const_value[i][j]);node.t.const_value.push(col)}}}else if(node.arguments.length>1){var val=[],mval=[];node.t.is_const_expression=!0;for(var i=0;i<node.arguments.length;i++){var arg=node.arguments[i];if(tp.is_mat&&arg.t.type.is_mat)return void this._error(arg.location(),"cannot construct matrix with intermixed matrix argument");if(arg.t.is_const_expression){var v=arg.t.const_value;if(!arg.t.type.is_primitive)return void this._error(arg.location(),"cannot use value of type "+arg.t.type.name+" to construct value of type "+tp.name);arg.t.type.is_scalar&&(v=[v]);for(var j=0;j<v.length;j++){if(val.length==tp.length){if(!tp.is_mat)return void this._error(arg.location(),"too many values to construct value of type "+tp.name);if(mval.push(val),val=[],mval.length==tp.length)return void this._error(arg.location(),"too many values to construct value of type "+tp.name)}val.push(v[j])}}else node.t.is_const_expression=!1}if(val.length!=tp.length)return void this._error(node.location(),"not enough values to fully construct type "+tp.name);if(tp.is_mat&&(mval.push(val),mval.length!=tp.length))return void this._error(node.location(),"not enough values to fully construct type "+tp.name);node.t.is_const_expression&&(node.t.const_value=tp.is_mat?mval:val)}else node.t.is_const_expression=!0,node.t.const_value=node.t.type.zero}else{if(node.arguments.length!=tp.fields.length)return void this._error(node.location(),"expected "+tp.fields.length+" arguments, but got "+node.arguments.length);node.t.is_const_expression=!0;for(var val={},i=0;i<node.arguments.length;i++){var arg=node.arguments[i],field=tp.fields[i];arg.t.type==field.type?arg.t.is_const_expression&&(val[field.name]=arg.t.const_value,node.t.is_const_expression=!0):this._error(arg.location(),"cannot initialize "+tp.name+"."+field.name+" with type "+field.type.name+" from argument of type "+arg.t.type.name)}node.t.is_const_expression&&(node.t.const_value=val)}}},Annotator.prototype._annotate_variable_expr=function(node){this._init_expr(node);var sym=this._lookup_symbol(node.name.text);node.t.decl=null,null===sym?this._error(node.location(),"undefined variable "+node.name.text):glsl.ast.Named.prototype.isPrototypeOf(sym)&&glsl.ast.VariableDecl.prototype.isPrototypeOf(sym.decl)||glsl.ast.ParamDecl.prototype.isPrototypeOf(sym)?(node.t.decl=sym,node.t.type=sym.t.type,glsl.ast.Named.prototype.isPrototypeOf(sym)&&sym.t.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=sym.t.const_value)):this._error(node.location(),"expected a variable for "+node.name.text+" but got a "+this._error_symbol_type_name(sym))},Annotator.prototype._validate_lvalue=function(node){if(null===node.t.type)return!1;switch(Object.getPrototypeOf(node)){case glsl.ast.GroupExpr.prototype:return this._validate_lvalue(node.expression);case glsl.ast.VariableExpr.prototype:return node.t.decl.type.is_uniform()?(this._error(node.location(),"cannot assign to uniform value"),!1):(node.t.decl.type.is_const()&&this._error(node.location(),"cannot assign to const value"),!0);case glsl.ast.FieldSelectionExpr.prototype:if(!this._validate_lvalue(node.expression))return!1;if(node.expression.t.type.is_vec){var chars=node.selector.text.split("");chars.sort();for(var found=null,i=0;i<chars.length-1;i++)if(chars[i]==chars[i+1]){found=chars[i];break}if(null!==found){var first=node.selector.text.indexOf(found),second=node.selector.text.indexOf(found,first+1);return this._error(node.selector.location().advance_chars(second),"cannot assign to repeated swizzle"),!1}}return!0;case glsl.ast.IndexExpr.prototype:return this._validate_lvalue(node.expression)?!0:!1;default:return this._error(node.location(),"cannot assign to expression"),!1}},Annotator.prototype._annotate_assignment_expr=function(node){if(this._init_expr(node),this._annotate_node(node.lhs),this._annotate_node(node.rhs),node.t.type=node.lhs.t.type,null!==node.lhs.t.type&&null!==node.rhs.t.type){var binop=null;
switch(node.op.id){case Tn.T_MUL_ASSIGN:binop=Tn.T_STAR;break;case Tn.T_DIV_ASSIGN:binop=Tn.T_SLASH;break;case Tn.T_ADD_ASSIGN:binop=Tn.T_PLUS;break;case Tn.T_SUB_ASSIGN:binop=Tn.T_DASH}var rettype=node.rhs.t.type;if(null!==binop){var sig=Tn.token_name(binop)+"("+node.lhs.t.type.name+","+node.rhs.t.type.name+")";if(sig in this._builtins.operator_map){var oper=this._builtins.operator_map[sig];rettype=oper.ret}else this._error(node.location(),"cannot use the operator '"+Tn.token_name(binop)+"' on types "+node.lhs.t.type.name+" and "+node.rhs.t.type.name)}node.lhs.t.type!=rettype&&this._error(node.lhs.location().extend(node.op.location),"cannot assign expression of type "+node.rhs.t.type.name+" to a value of type "+node.lhs.t.type.name)}glsl.ast.VariableExpr.prototype.isPrototypeOf(node.lhs)&&null!==node.lhs.t.type&&node.lhs.t.type.is_array&&this._error(node.lhs.location(),"cannot assign to array"),this._validate_lvalue(node.lhs)},Annotator.prototype._annotate_bin_op_expr=function(node){if(this._init_expr(node),this._annotate_node(node.lhs),this._annotate_node(node.rhs),null===node.lhs.t.type)node.t.type=node.rhs.t.type;else if(null===node.rhs.t.type)node.t.type=node.lhs.t.type;else if(null!==node.lhs.t.type&&null!==node.rhs.t.type){if((node.op.id==Tn.T_EQ_OP||node.op.id==Tn.T_NE_OP)&&node.lhs.t.type==node.rhs.t.type)return node.lhs.t.type.is_composite&&node.lhs.t.type.has_array_field?this._error(node.op.location,"cannot compare structures with array fields"):node.lhs.t.type.is_composite&&node.lhs.t.type.has_sampler_field?this._error(node.op.location,"cannot compare structures with sampler fields"):node.lhs.t.type.is_array?this._error(node.op.location,"cannot compare arrays"):node.lhs.t.type.is_sampler&&this._error(node.op.location,"cannot compare samplers"),void(node.t.type=this._builtins.Bool);var sig=node.op.text+"("+node.lhs.t.type.name+","+node.rhs.t.type.name+")";if(sig in this._builtins.operator_map){var op=this._builtins.operator_map[sig];node.t.type=op.ret,node.lhs.t.is_const_expression&&node.rhs.t.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=op.evaluate(node.lhs.t.const_value,node.rhs.t.const_value))}else this._error(node.location(),"cannot use the '"+node.op.text+"' operator on types "+node.lhs.t.type.name+" and "+node.rhs.t.type.name)}},Annotator.prototype._annotate_unary_op_expr=function(node){if(this._init_expr(node),this._annotate_node(node.expression),null!==node.expression.t.type){var sig=node.op.text+"("+node.expression.t.type.name+")";if(sig in this._builtins.operator_map){var op=this._builtins.operator_map[sig];node.t.type=op.ret,node.expression.t.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=glsl.ast.UnaryPostfixOpExpr.prototype.isPrototypeOf(node)?node.expression.t.const_value:op.evaluate(node.expression.t.const_value))}else this._error(node.location(),"cannot use the '"+node.op.text+"' operator on type "+node.expression.t.type.name)}},Annotator.prototype._annotate_unary_postfix_op_expr=function(node){this._annotate_unary_op_expr(node)},Annotator.prototype._annotate_ternary_expr=function(node){this._init_expr(node),this._annotate_node(node.condition),this._annotate_node(node.true_expression),this._annotate_node(node.false_expression),null!==node.condition.t.type&&node.condition.t.type!=this._builtins.Bool&&this._error(node.condition.location(),"the condition of a ternary conditional expression must be of type bool, not "+node.condition.t.type.name),(null!==node.true_expression.t.type||null!==node.false_expression.t.type)&&(null===node.true_expression.t.type?node.t.type=node.false_expression.t.type:null===node.false_expression.t.type?node.t.type=node.true_expression.t.type:node.true_expression.t.type!=node.false_expression.t.type?(this._error(node.true_expression.location().extend(node.false_expression.location()),"the true expression and false expression must be of the same type, but got "+node.true_expression.t.type.name+" and "+node.false_expression.t.type.name),node.t.type=node.true_expression.t.type):node.t.type=node.true_expression.t.type,node.condition.t.is_const_expression&&(node.condition.t.const_value?node.true_expression.t.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=node.true_expression.t.const_value):node.false_expression.t.is_const_expression&&(node.t.is_const_expression=!0,node.t.const_value=node.false_expression.t.const_value)))},Annotator.prototype._annotate_index_expr=function(node){this._init_expr(node),this._annotate_node(node.expression),this._annotate_node(node.index);var et=node.expression.t.type;if(null!==et)if(!et.is_array&&!et.is_primitive||et.length<=1)this._error(node.expression.location(),"only vectors, matrices and arrays can be indexed, not "+et.name);else if(null!==node.index.t.type&&node.index.t.type.is_const_expression&&node.index.t.type.const_value>=et.length)this._error(node.index.location(),"index out of bounds, trying to index element "+node.index.t.type.const_value+" in a value of length "+et.length);else if(et.is_primitive)if(et.is_mat){var m={2:this._builtins.Vec2,3:this._builtins.Vec3,4:this._builtins.Vec4};node.t.type=m[et.length]}else et.is_float?node.t.type=this._builtins.Float:et.is_int?node.t.type=this._builtins.Int:et.is_bool&&(node.t.type=this._builtins.Bool);else et.is_array&&(node.t.type=et.element_type);null!==node.index.t.type&&(node.index.t.type!=this._builtins.Int?this._error(node.index.location(),"expected integer index expression, but got expression of type "+node.index.t.type.name):node.index.t.is_const_expression?node.expression.t.is_const_expression&&(node.t.const_value=node.expression.t.const_value[node.index.t.const_value],node.t.is_const_expression=!0):this._error(node.index.location(),"cannot use dynamic indexing"))},Annotator.prototype._annotate_field_selection_expr=function(node){this._init_expr(node),this._annotate_node(node.expression);var et=node.expression.t.type;if(null!==et){var s=node.selector.text;if(et.is_primitive)if(et.is_vec){var components={x:0,y:0,z:0,w:0,r:1,g:1,b:1,a:1,s:2,t:2,p:2,q:2},cgroups=["xyzw","rgba","stpq"];if(s.length>4)return void this._error(node.selector.location,"component selection on vectors is limited to a maximum of 4 elements, got "+s.length);var tps=[];if(et.is_float?tps=[Tn.T_FLOAT,Tn.T_VEC2,Tn.T_VEC3,Tn.T_VEC4]:et.is_int?tps=[Tn.T_INT,Tn.T_IVEC2,Tn.T_IVEC3,Tn.T_IVEC4]:et.is_bool&&(tps=[Tn.T_BOOL,Tn.T_BVEC2,Tn.T_BVEC3,Tn.T_BVEC4]),node.t.type=this._builtins.type_map[tps[s.length-1]].type.t.type,node.expression.t.is_const_expression)if(node.t.is_const_expression=!0,node.t.type.is_vec){node.t.const_value=[];for(var i=0;i<node.t.type.length;i++)node.t.const_value.push(0)}else node.t.const_value=0;for(var ci=0,i=0;i<s.length;i++){var c=s[i];if(!(c in components))return void this._error(node.selector.location.start.advance_chars(i).to_range(),"invalid component selector '"+c+"', expected one of 'xyzw' 'rgba' or 'stpq'");if(0!==i&&ci!=components[c])return void this._error(node.selector.location.start.advance_chars(i).to_range(),"cannot mix components of different groups, expected one of '"+cgroups[ci]+"'");ci=components[c];var j=cgroups[ci].indexOf(c);if(j>=et.length)return void this._error(node.selector.location.start.advance_chars(i).to_range(),"selector out of bounds, expression has only "+et.length+" components, but tried to select component "+(ci+1));node.expression.t.is_const_expression&&(node.t.type.is_vec?node.const_value[i]=node.expression.t.const_value[j]:node.const_value=node.expression.t.const_value[j])}}else this._error(node.expression.location().extend(node.op.location),"selector '"+s+"' does not apply to an expression of type "+et.name);else if(et.is_composite)if(s in et.field_map){var f=et.field_map[s];node.expression.t.is_const_expression&&s in node.expression.t.const_value&&(node.t.is_const_expression=!0,node.t.const_value=node.expression.t.const_value[s]),node.t.type=f.type}else this._error(node.selector.location,"the field '"+s+"' does not exist in the struct type "+et.name);else this._error(node.selector.location,"cannot apply selector '"+s+"' to expression of type "+et.name)}},Annotator.prototype._copy_type=function(dest,src){dest.t.type=src.t.type,dest.t.is_const_expression=src.t.is_const_expression,dest.t.const_value=src.t.const_value},Annotator.prototype._annotate_group_expr=function(node){this._init_expr(node),this._annotate_node(node.expression),this._copy_type(node,node.expression)},Annotator.prototype._annotate_expression_list_stmt=function(node){for(var i=0;i<node.expressions.length;i++)this._annotate_node(node.expressions[i]);this._copy_type(node,node.expressions[node.expressions.length-1])},Annotator.prototype._annotate_do_stmt=function(node){this._annotate_node(node.condition),null!==node.condition.t.type&&node.condition.t.type!==this._builtins.Bool&&this._error(node.condition.location(),"condition must of of type bool, got type "+node.condition.t.type.name),this._annotate_node(node.body)},Annotator.prototype._annotate_while_stmt=function(node){this._push_scope(node),this._annotate_node(node.condition),null!==node.condition.t.type&&node.condition.t.type!==this._builtins.Bool&&this._error(node.condition.location(),"condition must of of type bool, got type "+node.condition.t.type.name),this._annotate_node(node.body),this._pop_scope()},Annotator.prototype._annotate_for_rest_stmt=function(node){this._annotate_node(node.condition),null!==node.condition.t.type&&node.condition.t.type!==this._builtins.Bool&&this._error(node.condition.location(),"condition must of of type bool, got type "+node.condition.t.type.name),this._annotate_node(node.expression)},Annotator.prototype._annotate_for_stmt=function(node){this._push_scope(node),this._annotate_node(node.init),this._annotate_node(node.rest),this._annotate_node(node.body),this._pop_scope()},Annotator.prototype._annotate_selection_stmt=function(node){this._annotate_node(node.condition),null!==node.condition.t.type&&node.condition.t.type!==this._builtins.Bool&&this._error(node.condition.location(),"condition must of of type bool, got type "+node.condition.t.type.name),this._annotate_node(node.body),this._annotate_node(node.els)},Annotator.prototype._annotate_selection_else_stmt=function(node){this._annotate_node(node.body)},Annotator.prototype._annotate_break_stmt=function(){},Annotator.prototype._annotate_continue_stmt=function(){},Annotator.prototype._annotate_discard_stmt=function(){},Annotator.prototype._annotate_return_stmt=function(node){this._annotate_node(node.expression);for(var scope=this._scope;null!==scope&&!glsl.ast.FunctionDef.prototype.isPrototypeOf(scope);)scope=scope.parent_scope;null!==scope&&(scope.t.type===this._builtins.Void&&null!==node.expression?this._error(node.expression.location(),"returning value in a function with type void"):scope.t.type!==this._builtins.Void&&null!==node.expression&&null!==node.expression.t.type&&node.expression.t.type!=scope.t.type&&this._error(node.expression.location(),"expected return value of type "+scope.t.type.name+" but got value of type "+node.expression.t.type.name))},Annotator.prototype._annotate_no_match=function(){},Annotator.prototype._annotate_empty_stmt=function(){},Annotator.prototype._error=function(loc,message){this._errors.push(new Error(loc,message))},exports.Annotate=Annotate}(ns);
//# sourceMappingURL=glsl.all.min.js.map